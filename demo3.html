<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Necro-Lattice Demo 3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg: #03020b;
            --bg-grad-1: rgba(104, 52, 255, 0.36);
            --bg-grad-2: rgba(255, 148, 45, 0.4);
            --panel: rgba(17, 14, 31, 0.92);
            --panel-ghost: rgba(24, 19, 44, 0.78);
            --border: rgba(255, 255, 255, 0.12);
            --border-strong: rgba(255, 255, 255, 0.22);
            --text: #f7f2ff;
            --muted: rgba(247, 242, 255, 0.65);
            --accent: #ff8c32;
            --accent-strong: #ff6436;
            --success: #45f0c5;
            --danger: #ff4f6d;
            --warning: #ffd447;
            --shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background:
                radial-gradient(circle at 12% 18%, var(--bg-grad-1), transparent 45%),
                radial-gradient(circle at 82% 12%, var(--bg-grad-2), transparent 50%),
                linear-gradient(160deg, #020108 0%, #0f0a24 40%, #030108 100%);
            color: var(--text);
        }

        .toast {
            position: fixed;
            top: 26px;
            right: 24px;
            padding: 12px 16px;
            border-radius: 12px;
            background: rgba(8, 6, 16, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.16);
            color: var(--text);
            font-size: 0.95rem;
            opacity: 0;
            transform: translateY(-6px);
            transition: 200ms ease;
            pointer-events: none;
            z-index: 999;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        header.hero {
            padding: clamp(20px, 4vw, 40px) clamp(24px, 5vw, 60px);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: clamp(16px, 3vw, 40px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            background: linear-gradient(115deg, rgba(24, 20, 46, 0.93), rgba(14, 11, 29, 0.93));
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .hero-copy {
            flex: 1 1 420px;
            display: grid;
            gap: 16px;
        }

        .eyebrow {
            margin: 0;
            font-size: 0.78rem;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: var(--muted);
        }

        h1 {
            margin: 0;
            font-size: clamp(2.4rem, 5.4vw, 3.2rem);
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .tagline {
            margin: 0;
            font-size: clamp(0.98rem, 2.4vw, 1.18rem);
            line-height: 1.7;
            color: var(--muted);
            max-width: 720px;
        }

        .hero-cta-row {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            align-items: center;
        }

        .hero-cta {
            padding: 16px 28px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(120deg, var(--accent) 0%, var(--accent-strong) 100%);
            color: #1d0804;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 18px 46px rgba(255, 140, 50, 0.4);
            transition: transform 140ms ease;
        }

        .hero-cta:hover {
            transform: translateY(-2px);
        }

        .hero-note {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .hero-metrics {
            flex: 0 1 380px;
            display: grid;
            gap: 14px;
            background: rgba(12, 9, 22, 0.72);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 22px;
        }

        .metric-title {
            font-size: 0.8rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--muted);
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
        }

        .metric {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.07);
            padding: 16px 14px;
            display: grid;
            gap: 6px;
        }

        .metric span:first-child {
            font-size: 0.74rem;
            color: var(--muted);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .metric span:last-child {
            font-size: 1.35rem;
            font-weight: 700;
        }

        main {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(12, minmax(0, 1fr));
            grid-auto-rows: minmax(120px, auto);
            gap: clamp(16px, 3vw, 26px);
            padding: clamp(20px, 4vw, 40px);
        }

        .panel {
            background: var(--panel);
            border-radius: 22px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: clamp(18px, 3vw, 28px);
            display: flex;
            flex-direction: column;
            gap: 18px;
            position: relative;
        }

        .panel header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .panel h2 {
            margin: 0;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1.6px;
        }

        .panel p {
            margin: 0;
            color: var(--muted);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .sectors-panel {
            grid-column: span 5;
        }

        .glyph-panel {
            grid-column: span 4;
        }

        .control-panel {
            grid-column: span 3;
            display: grid;
            gap: 18px;
        }

        @media (max-width: 1220px) {
            .sectors-panel {
                grid-column: span 6;
            }
            .glyph-panel {
                grid-column: span 6;
            }
            .control-panel {
                grid-column: span 12;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        @media (max-width: 900px) {
            main {
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }
            .sectors-panel, .glyph-panel, .control-panel {
                grid-column: span 6;
            }
        }

        .chip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .chip {
            display: grid;
            gap: 6px;
            padding: 16px 14px;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.04);
            cursor: pointer;
            transition: 140ms ease;
            text-align: left;
        }

        .chip span:first-child {
            font-size: 0.72rem;
            color: var(--muted);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .chip span:last-child {
            font-size: 1.05rem;
            font-weight: 600;
        }

        .chip:hover {
            background: rgba(255, 140, 50, 0.12);
            border-color: rgba(255, 140, 50, 0.6);
        }

        .chip.active {
            border-color: rgba(255, 140, 50, 0.95);
            background: radial-gradient(circle, rgba(255, 140, 50, 0.26) 0%, rgba(255, 140, 50, 0.08) 70%);
            box-shadow: 0 12px 34px rgba(255, 140, 50, 0.28);
        }

        .glyph-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 110px));
            gap: 14px;
            justify-content: center;
            padding: 18px;
            border-radius: 22px;
            background: rgba(0, 0, 0, 0.22);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glyph {
            width: 110px;
            height: 110px;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.04);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: rgba(255, 255, 255, 0.45);
            transition: 140ms ease;
        }

        .glyph.lit {
            border-color: var(--warning);
            background: radial-gradient(circle, rgba(255, 212, 71, 0.3) 0%, rgba(255, 212, 71, 0.1) 70%);
            color: var(--warning);
            box-shadow: 0 0 34px rgba(255, 212, 71, 0.26);
        }

        .glyph.obelisk {
            font-size: 2rem;
        }

        .glyph.obelisk.lit {
            border-color: var(--accent-strong);
            color: var(--accent-strong);
            box-shadow: 0 0 30px rgba(255, 100, 54, 0.34);
        }

        .line-list {
            display: grid;
            gap: 12px;
        }

        .line-chip {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            border-radius: 16px;
            border: 1px dashed rgba(255, 255, 255, 0.16);
            background: rgba(255, 255, 255, 0.04);
            cursor: pointer;
            transition: 140ms ease;
        }

        .line-chip span:first-child {
            font-weight: 600;
        }

        .line-chip span:last-child {
            font-size: 0.8rem;
            color: var(--muted);
            letter-spacing: 0.4px;
            text-transform: uppercase;
        }

        .line-chip:hover {
            border-color: rgba(255, 140, 50, 0.45);
            background: rgba(255, 140, 50, 0.12);
        }

        .line-chip.active {
            border-style: solid;
            border-color: rgba(255, 140, 50, 0.85);
            background: rgba(255, 140, 50, 0.18);
            box-shadow: 0 10px 30px rgba(255, 140, 50, 0.22);
        }

        .control-stack {
            display: grid;
            gap: 18px;
            background: var(--panel-ghost);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: clamp(18px, 3vw, 26px);
        }

        .input-group {
            display: grid;
            gap: 8px;
        }

        .input-group label {
            font-size: 0.78rem;
            color: var(--muted);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .stake-input {
            padding: 12px 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            font-size: 1.1rem;
        }

        .stake-input:focus {
            outline: none;
            border-color: rgba(255, 140, 50, 0.6);
            box-shadow: 0 0 0 3px rgba(255, 140, 50, 0.25);
        }

        .quick-row {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 10px;
        }

        .quick-row button {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            transition: 130ms ease;
        }

        .quick-row button:hover {
            background: rgba(255, 140, 50, 0.14);
            border-color: rgba(255, 140, 50, 0.48);
        }

        .summary-bar {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            padding: 16px 18px;
            border-radius: 16px;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-bar div {
            display: grid;
            gap: 4px;
        }

        .summary-bar span:first-child {
            font-size: 0.72rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-bar span:last-child {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .cta-button {
            padding: 16px 24px;
            border-radius: 18px;
            border: none;
            background: linear-gradient(120deg, var(--accent) 0%, var(--accent-strong) 100%);
            color: #1f0804;
            font-size: 1.2rem;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 18px 42px rgba(255, 140, 50, 0.34);
            transition: transform 130ms ease;
        }

        .cta-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            box-shadow: none;
        }

        .cta-button:not(:disabled):hover {
            transform: translateY(-2px);
        }

        .extortion-banner {
            padding: 12px 16px;
            border-radius: 14px;
            background: rgba(255, 79, 109, 0.14);
            border: 1px solid rgba(255, 79, 109, 0.35);
            color: var(--muted);
            font-size: 0.86rem;
        }

        .extortion-banner strong {
            color: var(--danger);
        }

        .outcome-card {
            background: var(--panel-ghost);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: clamp(18px, 3vw, 26px);
            display: grid;
            gap: 14px;
        }

        .outcome-card h3 {
            margin: 0;
            font-size: 0.95rem;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            color: var(--muted);
        }

        .outcome-card .net {
            font-size: 2.4rem;
            font-weight: 800;
        }

        .outcome-card.win {
            border-color: rgba(69, 240, 197, 0.44);
            box-shadow: 0 18px 50px rgba(69, 240, 197, 0.2);
        }

        .outcome-card.win .net {
            color: var(--success);
        }

        .outcome-card.loss {
            border-color: rgba(255, 79, 109, 0.4);
            box-shadow: 0 18px 50px rgba(255, 79, 109, 0.18);
        }

        .outcome-card.loss .net {
            color: var(--danger);
        }

        .outcome-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tag {
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            color: var(--muted);
            font-size: 0.78rem;
        }

        .history-card {
            background: var(--panel-ghost);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: clamp(18px, 3vw, 26px);
            display: grid;
            gap: 16px;
        }

        .history-card h2 {
            margin: 0;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1.6px;
        }

        .history-list {
            max-height: 240px;
            overflow-y: auto;
            display: grid;
            gap: 12px;
        }

        .history-item {
            font-size: 0.86rem;
            color: var(--muted);
            line-height: 1.5;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .history-item strong {
            color: var(--text);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.12);
            border-radius: 999px;
        }
    </style>
</head>
<body>
    <div class="toast" id="toast"></div>
    <header class="hero">
        <div class="hero-copy">
            <p class="eyebrow">Commissioner's private circuit</p>
            <h1>Necro-Lattice</h1>
            <p class="tagline">Stake sectors, bind glyph prophecies, and drive the ritual wheel. Glowing victories scream across the board—losses flare crimson. The entire grid is yours; no cramped columns, no guessing what matters.</p>
            <div class="hero-cta-row">
                <button class="hero-cta" id="heroSpin">Spin ritual wheel</button>
                <span class="hero-note">Step 1: arm sectors or glyph lines below. Step 2: set a stake. Step 3: ignite.</span>
            </div>
        </div>
        <aside class="hero-metrics">
            <span class="metric-title">Spin readiness snapshot</span>
            <div class="metric">
                <span>Total risked next spin</span>
                <span id="summaryRisk">0 VC</span>
            </div>
            <div class="metric-grid">
                <div class="metric">
                    <span>Sectors armed</span>
                    <span id="summarySectors">0</span>
                </div>
                <div class="metric">
                    <span>Glyph lines bound</span>
                    <span id="summaryLines">0</span>
                </div>
                <div class="metric">
                    <span>Base stake</span>
                    <span id="summaryStake">100 VC</span>
                </div>
                <div class="metric">
                    <span>Balance</span>
                    <span id="summaryBalance">5,000 VC</span>
                </div>
            </div>
        </aside>
    </header>

    <main>
        <section class="panel sectors-panel">
            <header>
                <h2>Sectors · roulette bones</h2>
                <span class="hero-note">Direct hits pay 10× · adjacency pays 3×</span>
            </header>
            <div class="chip-grid" id="sectorGrid"></div>
        </section>

        <section class="panel glyph-panel">
            <header>
                <h2>Doom grid · glyph prophecies</h2>
                <span class="hero-note">Rows/columns 5× · diagonals 8× · obelisk unlocks bonus spin</span>
            </header>
            <div class="glyph-grid" id="glyphGrid"></div>
            <div class="line-list" id="lineGrid"></div>
        </section>

        <section class="control-panel">
            <div class="control-stack">
                <header>
                    <h2>Wager planner</h2>
                    <span class="hero-note">Set stake · confirm risk · slam spin</span>
                </header>
                <div class="input-group">
                    <label for="stakeInput">Base stake per selection</label>
                    <input type="number" id="stakeInput" class="stake-input" min="10" step="10" value="100">
                </div>
                <div class="quick-row">
                    <button type="button" data-stake="50">50</button>
                    <button type="button" data-stake="100">100</button>
                    <button type="button" data-stake="250">250</button>
                    <button type="button" data-stake="500">500</button>
                    <button type="button" id="maxStake">MAX</button>
                </div>
                <div class="summary-bar">
                    <div>
                        <span>Total selections</span>
                        <span id="summarySelections">0</span>
                    </div>
                    <div>
                        <span>Total risk</span>
                        <span id="summaryTotal">0 VC</span>
                    </div>
                </div>
                <button class="cta-button" id="spinBtn">Spin ritual wheel</button>
                <div class="extortion-banner" id="extortionBanner" hidden>
                    <strong>Extortion active:</strong> 10% skim on next win. Keep spinning to shake the goons.
                </div>
            </div>

            <div class="outcome-card" id="outcomeCard">
                <h3>Awaiting your command</h3>
                <div>
                    <div class="net" id="outcomeNet">—</div>
                    <p id="outcomeCopy">Arm a few bets then hammer Spin. Results light up here with glowing wins or crimson losses.</p>
                </div>
                <div class="outcome-tags" id="outcomeTags"></div>
            </div>

            <div class="history-card">
                <h2>Ledger · last 8 pulls</h2>
                <div class="history-list" id="history"></div>
            </div>
        </section>
    </main>

    <script>
        const toastEl = document.getElementById('toast');
        const stakeInput = document.getElementById('stakeInput');
        const spinBtn = document.getElementById('spinBtn');
        const heroSpin = document.getElementById('heroSpin');
        const summaryRisk = document.getElementById('summaryRisk');
        const summarySectors = document.getElementById('summarySectors');
        const summaryLines = document.getElementById('summaryLines');
        const summaryStake = document.getElementById('summaryStake');
        const summaryBalance = document.getElementById('summaryBalance');
        const summarySelections = document.getElementById('summarySelections');
        const summaryTotal = document.getElementById('summaryTotal');
        const outcomeCard = document.getElementById('outcomeCard');
        const outcomeNet = document.getElementById('outcomeNet');
        const outcomeCopy = document.getElementById('outcomeCopy');
        const outcomeTags = document.getElementById('outcomeTags');
        const historyEl = document.getElementById('history');
        const extortionBanner = document.getElementById('extortionBanner');

        const balanceState = {
            balance: 5000,
            consecutiveBusts: 0
        };

        const SECTORS = [
            { id: 0, name: 'Acid Fog' },
            { id: 1, name: 'Bone Hail' },
            { id: 2, name: 'Witch Tide' },
            { id: 3, name: 'Gospel Static' },
            { id: 4, name: 'Spinal Bloom' },
            { id: 5, name: 'Ritual Ash' },
            { id: 6, name: 'Blunt Singularity' },
            { id: 7, name: 'Plasma Dirge' },
            { id: 8, name: 'Mire Choir' },
            { id: 9, name: 'Vanta Gale' },
            { id: 10, name: 'Copium Surge' },
            { id: 11, name: 'Axe Eclipse' },
            { id: 12, name: 'Cathedral Feedback' }
        ];

        const GLYPH_INDICES = Array.from({ length: 9 }, (_, i) => i);
        const LINES = [
            { id: 'row0', label: 'Row · North Veil', cells: [0, 1, 2], multiplier: 5 },
            { id: 'row1', label: 'Row · Mid Vein', cells: [3, 4, 5], multiplier: 5 },
            { id: 'row2', label: 'Row · Grave Floor', cells: [6, 7, 8], multiplier: 5 },
            { id: 'col0', label: 'Column · Spine', cells: [0, 3, 6], multiplier: 5 },
            { id: 'col1', label: 'Column · Larynx', cells: [1, 4, 7], multiplier: 5 },
            { id: 'col2', label: 'Column · Maw', cells: [2, 5, 8], multiplier: 5 },
            { id: 'diag0', label: 'Sigil Diagonal ↘', cells: [0, 4, 8], multiplier: 8 },
            { id: 'diag1', label: 'Sigil Diagonal ↙', cells: [2, 4, 6], multiplier: 8 }
        ];

        const selectedSectors = new Set();
        const selectedLines = new Set();

        function showToast(message, duration = 2600) {
            toastEl.textContent = message;
            toastEl.classList.add('show');
            clearTimeout(showToast._timer);
            showToast._timer = setTimeout(() => toastEl.classList.remove('show'), duration);
        }

        function formatCredits(n) {
            return n.toLocaleString() + ' VC';
        }

        function updateBalanceDisplay() {
            summaryBalance.textContent = formatCredits(balanceState.balance);
        }

        function updateSummary() {
            const stake = Number(stakeInput.value) || 0;
            const selections = selectedSectors.size + selectedLines.size;
            const totalRisk = selections * stake;
            summarySectors.textContent = selectedSectors.size;
            summaryLines.textContent = selectedLines.size;
            summaryStake.textContent = formatCredits(stake);
            summarySelections.textContent = selections;
            summaryTotal.textContent = formatCredits(totalRisk);
            summaryRisk.textContent = formatCredits(totalRisk);
            spinBtn.disabled = selections === 0 || stake <= 0;
        }

        function buildSectorGrid() {
            const grid = document.getElementById('sectorGrid');
            SECTORS.forEach(({ id, name }) => {
                const chip = document.createElement('button');
                chip.type = 'button';
                chip.className = 'chip';
                chip.dataset.id = id;
                chip.innerHTML = `<span>${id.toString().padStart(2, '0')}</span><span>${name}</span>`;
                chip.addEventListener('click', () => {
                    if (selectedSectors.has(id)) {
                        selectedSectors.delete(id);
                        chip.classList.remove('active');
                    } else {
                        selectedSectors.add(id);
                        chip.classList.add('active');
                    }
                    updateSummary();
                });
                grid.appendChild(chip);
            });
        }

        function buildGlyphGrid() {
            const grid = document.getElementById('glyphGrid');
            GLYPH_INDICES.forEach(idx => {
                const glyph = document.createElement('div');
                glyph.className = 'glyph' + (idx === 4 ? ' obelisk' : '');
                glyph.id = `glyph-${idx}`;
                glyph.textContent = idx === 4 ? '☗' : '✶';
                grid.appendChild(glyph);
            });
        }

        function buildLines() {
            const list = document.getElementById('lineGrid');
            LINES.forEach(line => {
                const item = document.createElement('div');
                item.className = 'line-chip';
                item.dataset.id = line.id;
                item.innerHTML = `<span>${line.label}</span><span>${line.multiplier}× payout</span>`;
                item.addEventListener('click', () => {
                    if (selectedLines.has(line.id)) {
                        selectedLines.delete(line.id);
                        item.classList.remove('active');
                    } else {
                        selectedLines.add(line.id);
                        item.classList.add('active');
                    }
                    updateSummary();
                });
                list.appendChild(item);
            });
        }

        function randomInt(max) {
            return Math.floor(Math.random() * max);
        }

        function drawGlyphs(count = 3) {
            const pool = [...GLYPH_INDICES];
            const drawn = [];
            while (drawn.length < count && pool.length) {
                const idx = randomInt(pool.length);
                drawn.push(pool.splice(idx, 1)[0]);
            }
            return drawn;
        }

        function highlightGlyphs(indices) {
            GLYPH_INDICES.forEach(idx => {
                document.getElementById(`glyph-${idx}`).classList.toggle('lit', indices.includes(idx));
            });
        }

        function sectorNeighbors(id) {
            const len = SECTORS.length;
            return [(id + len - 1) % len, (id + 1) % len];
        }

        function evaluateSpin({ sectorResult, glyphs, stake, bonusSpin = false }) {
            let totalPayout = 0;
            const wins = [];

            selectedSectors.forEach(sel => {
                if (sel === sectorResult) {
                    const payout = stake * 10;
                    totalPayout += payout;
                    wins.push(`Sector ${sel.toString().padStart(2, '0')} direct hit · +${formatCredits(payout)}`);
                } else if (sectorNeighbors(sectorResult).includes(sel)) {
                    const payout = stake * 3;
                    totalPayout += payout;
                    wins.push(`Sector ${sel.toString().padStart(2, '0')} adjacency · +${formatCredits(payout)}`);
                }
            });

            selectedLines.forEach(lineId => {
                const line = LINES.find(l => l.id === lineId);
                if (!line) return;
                if (line.cells.every(idx => glyphs.includes(idx))) {
                    const payout = stake * line.multiplier;
                    totalPayout += payout;
                    wins.push(`${line.label} sealed · +${formatCredits(payout)}`);
                }
            });

            const totalCost = stake * (selectedSectors.size + selectedLines.size);
            const net = totalPayout - totalCost;
            const descriptor = bonusSpin ? 'Obelisk bonus resolved' : 'Ritual spin resolved';
            renderOutcome({
                descriptor,
                sector: `${sectorResult.toString().padStart(2, '0')} · ${SECTORS[sectorResult].name}`,
                glyphs: glyphs.map(idx => idx === 4 ? 'Obelisk' : `Sigil ${idx + 1}`).join(', '),
                net,
                wins
            });
            pushHistory({ descriptor, sectorResult, glyphs, net });
            return net;
        }

        function renderOutcome({ descriptor, sector, glyphs, net, wins }) {
            outcomeCard.classList.remove('win', 'loss');
            if (net > 0) outcomeCard.classList.add('win');
            if (net < 0) outcomeCard.classList.add('loss');

            outcomeCard.querySelector('h3').textContent = descriptor;
            outcomeNet.textContent = net === 0 ? '0 VC' : `${net > 0 ? '+' : ''}${formatCredits(Math.abs(net))}`;

            if (net > 0) {
                outcomeCopy.textContent = 'Violence Credits deployed to your ledger. Keep pressing while the lattice hums.';
            } else if (net < 0) {
                outcomeCopy.textContent = 'Commissioner pockets the burn. Stack more prophecy before the next pull.';
            } else {
                outcomeCopy.textContent = 'Perfect balance. The ritual neither rewards nor punishes.';
            }

            outcomeTags.innerHTML = '';
            const sTag = document.createElement('span');
            sTag.className = 'tag';
            sTag.textContent = `Sector: ${sector}`;
            outcomeTags.appendChild(sTag);
            const gTag = document.createElement('span');
            gTag.className = 'tag';
            gTag.textContent = `Glyphs: ${glyphs}`;
            outcomeTags.appendChild(gTag);
            wins.forEach(text => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.textContent = text;
                outcomeTags.appendChild(tag);
            });
        }

        function pushHistory({ descriptor, sectorResult, glyphs, net }) {
            const entry = document.createElement('div');
            entry.className = 'history-item';
            entry.innerHTML = `
                <strong>${net > 0 ? 'Win' : net < 0 ? 'Loss' : 'Draw'}</strong> · ${descriptor}<br>
                Sector ${sectorResult.toString().padStart(2, '0')} · Glyphs ${glyphs.join('-')} · Net ${net > 0 ? '+' : ''}${formatCredits(net)}
            `;
            historyEl.prepend(entry);
            if (historyEl.children.length > 8) historyEl.removeChild(historyEl.lastElementChild);
        }

        function performSpin({ stake, bonusOnly = false }) {
            const sectorResult = randomInt(SECTORS.length);
            const glyphs = drawGlyphs(3);
            highlightGlyphs(glyphs);
            return { sectorResult, glyphs, stake, bonusSpin: bonusOnly };
        }

        function triggerExtortion() {
            showToast('Extortion crew found you. Next win loses 10%.', 3200);
            triggerExtortion.tax = 0.10;
            extortionBanner.hidden = false;
            setTimeout(() => {
                triggerExtortion.tax = 0;
                extortionBanner.hidden = true;
                showToast('Extortion ended. Winnings now untaxed.');
            }, 90000);
        }

        function applyExtortion(net) {
            const tax = triggerExtortion.tax || 0;
            if (!tax || net <= 0) return net;
            const skimmed = Math.floor(net * (1 - tax));
            showToast(`Goons skimmed ${formatCredits(net - skimmed)}.`);
            triggerExtortion.tax = 0;
            extortionBanner.hidden = true;
            return skimmed;
        }

        function handleSpin() {
            const stake = Math.max(Number(stakeInput.value) || 0, 0);
            const selections = selectedSectors.size + selectedLines.size;
            if (selections === 0 || stake <= 0) {
                showToast('Queue at least one sector or glyph line and set a stake.');
                return;
            }
            const totalCost = stake * selections;
            if (totalCost > balanceState.balance) {
                showToast('Insufficient Violence Credits. Dial the stake or deselect bets.');
                return;
            }

            balanceState.balance -= totalCost;
            updateBalanceDisplay();

            const primary = performSpin({ stake });
            let net = evaluateSpin(primary);

            const obeliskHit = primary.glyphs.includes(4) && selectedLines.size > 0;
            if (obeliskHit) {
                showToast('Obelisk flare. Half-stake glyph-only bonus incoming.');
                const bonusStake = Math.max(Math.floor(stake / 2), 10);
                const saved = new Set(selectedSectors);
                selectedSectors.clear();
                const bonus = performSpin({ stake: bonusStake, bonusOnly: true });
                net += evaluateSpin(bonus);
                selectedSectors.clear();
                saved.forEach(id => selectedSectors.add(id));
            }

            const finalNet = net > 0 ? applyExtortion(net) : net;
            balanceState.balance += finalNet;
            updateBalanceDisplay();

            balanceState.consecutiveBusts = finalNet <= 0 ? balanceState.consecutiveBusts + 1 : 0;
            if (balanceState.consecutiveBusts >= 2 && !triggerExtortion.tax) {
                triggerExtortion();
                balanceState.consecutiveBusts = 0;
            }

            updateSummary();
        }

        function init() {
            buildSectorGrid();
            buildGlyphGrid();
            buildLines();
            updateSummary();
            updateBalanceDisplay();

            document.querySelectorAll('.quick-row button').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.id === 'maxStake') {
                        const selections = Math.max(1, selectedSectors.size + selectedLines.size);
                        stakeInput.value = Math.max(10, Math.floor(balanceState.balance / selections));
                    } else {
                        stakeInput.value = btn.dataset.stake;
                    }
                    updateSummary();
                });
            });

            stakeInput.addEventListener('input', updateSummary);
            spinBtn.addEventListener('click', handleSpin);
            heroSpin.addEventListener('click', () => {
                spinBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                spinBtn.classList.add('pulse');
                setTimeout(() => spinBtn.classList.remove('pulse'), 1000);
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

