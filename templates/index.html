{{define "content"}}

	<div class="tournament-header">
		{{if .Tournament}}
			<div class="tournament-banner">
				<h1 style="font-size: 2em; font-weight: bold;">2025 <span style="color: #ff0000;">FALL</span> SEASON</h1>
				<h2 class="tournament-title"><center>{{.Tournament.Name}}</center></h2>
				<p class="sponsor"><center>Sponsored by <strong title="Spoodblort Inc. is not affiliated with {{.Tournament.Sponsor}}, for legal reasons. - Spoodblort Inc. Legal Team">{{.Tournament.Sponsor}}</strong></center></p>
				<div class="tournament-meta">
					<span class="week-badge">Week {{.Tournament.WeekNumber}}</span>
					<span class="date-badge">{{.Tournament.StartDate.Format "January 2, 2006"}}</span>
				</div>
			</div>
		{{end}}
	</div>

	{{/* Prepare fight context */}}
	{{$nextFight := .NextFight}}
	{{$activeFight := ""}}
	{{$lastCompleted := ""}}
	{{range .Fights}}
		{{if eq .Status "active"}}
			{{$activeFight = .}}
		{{end}}
		{{if eq .Status "completed"}}
			{{$lastCompleted = .}}
		{{end}}
	{{end}}

	{{if or $nextFight $activeFight $lastCompleted}}
		<section class="hero">
			{{if $activeFight}}
				<article class="card">
					<div class="card-header">
						<h3>Live Right Now</h3>
						<span class="pill live">LIVE</span>
					</div>
					<div class="card-body">
						<div class="live-grid">
							<div class="fighter">
								{{if index $.FighterMap $activeFight.Fighter1ID}}
									<a href="/fighter/{{$activeFight.Fighter1ID}}" style="text-decoration:none; border-bottom:none;">
										<img class="live-avatar-img" src="{{(index $.FighterMap $activeFight.Fighter1ID).AvatarURL}}" alt="{{$activeFight.Fighter1Name}}">
									</a>
								{{end}}
								<div class="name"><a href="/fighter/{{$activeFight.Fighter1ID}}">{{$activeFight.Fighter1Name}}{{if and $.CurrentMVP (eq $.CurrentMVP.SettingValue (printf "%d" $activeFight.Fighter1ID))}} ðŸ‘‘{{end}}</a></div>
								<div class="record">&nbsp;</div>
							</div>
							<div class="vs-chip">VS</div>
							<div class="fighter" style="text-align:right;">
								{{if index $.FighterMap $activeFight.Fighter2ID}}
									<a href="/fighter/{{$activeFight.Fighter2ID}}" style="text-decoration:none; border-bottom:none;">
										<img class="live-avatar-img" src="{{(index $.FighterMap $activeFight.Fighter2ID).AvatarURL}}" alt="{{$activeFight.Fighter2Name}}" style="justify-self:end;">
									</a>
								{{end}}
								<div class="name"><a href="/fighter/{{$activeFight.Fighter2ID}}">{{$activeFight.Fighter2Name}}{{if and $.CurrentMVP (eq $.CurrentMVP.SettingValue (printf "%d" $activeFight.Fighter2ID))}} ðŸ‘‘{{end}}</a></div>
								<div class="record">&nbsp;</div>
							</div>
						</div>
						<a class="cta" href="/watch/{{$activeFight.ID}}">âš¡ WATCH NOW</a>
					</div>
				</article>
			{{else if $lastCompleted}}
				<article class="card">
					<div class="card-header">
						<h3>Most Recent Fight</h3>
						<span class="pill completed">COMPLETED</span>
					</div>
					<div class="card-body">
						<div class="live-grid">
							<div class="fighter">
								{{if index $.FighterMap $lastCompleted.Fighter1ID}}
									<a href="/fighter/{{$lastCompleted.Fighter1ID}}" style="text-decoration:none; border-bottom:none;">
										<img class="live-avatar-img" src="{{(index $.FighterMap $lastCompleted.Fighter1ID).AvatarURL}}" alt="{{$lastCompleted.Fighter1Name}}">
									</a>
								{{end}}
								<div class="name"><a href="/fighter/{{$lastCompleted.Fighter1ID}}">{{$lastCompleted.Fighter1Name}}{{if and $.CurrentMVP (eq $.CurrentMVP.SettingValue (printf "%d" $lastCompleted.Fighter1ID))}} ðŸ‘‘{{end}}</a></div>
								<div class="record">&nbsp;</div>
							</div>
							<div class="vs-chip">VS</div>
							<div class="fighter" style="text-align:right;">
								{{if index $.FighterMap $lastCompleted.Fighter2ID}}
									<a href="/fighter/{{$lastCompleted.Fighter2ID}}" style="text-decoration:none; border-bottom:none;">
										<img class="live-avatar-img" src="{{(index $.FighterMap $lastCompleted.Fighter2ID).AvatarURL}}" alt="{{$lastCompleted.Fighter2Name}}" style="justify-self:end;">
									</a>
								{{end}}
								<div class="name"><a href="/fighter/{{$lastCompleted.Fighter2ID}}">{{$lastCompleted.Fighter2Name}}{{if and $.CurrentMVP (eq $.CurrentMVP.SettingValue (printf "%d" $lastCompleted.Fighter2ID))}} ðŸ‘‘{{end}}</a></div>
								<div class="record">&nbsp;</div>
							</div>
						</div>
						<a class="cta" href="/fight/{{$lastCompleted.ID}}">View Fight</a>
					</div>
				</article>
			{{end}}

			{{if $nextFight}}
				<aside class="card">
					<div class="card-header">
						<h3>Next Fight</h3>
						<span class="pill next">UPCOMING</span>
					</div>
					<div class="card-body countdown">
						<div class="timer">
							<span class="countdown-timer"
								data-target-time="{{$nextFight.ScheduledTime.Format "2006-01-02T15:04:05Z07:00"}}"
								data-fight-id="{{$nextFight.ID}}"
								data-fighter1="{{$nextFight.Fighter1Name}}"
								data-fighter2="{{$nextFight.Fighter2Name}}">
								<span class="countdown-display">Calculating chaos...</span>
							</span>
						</div>
						<div class="meter"><i id="idxMeterFill"></i></div>
						<div style="color:var(--idx-dim)"><strong>{{$nextFight.Fighter1Name}}{{if and $.CurrentMVP (eq $.CurrentMVP.SettingValue (printf "%d" $nextFight.Fighter1ID))}} ðŸ‘‘{{end}}</strong> vs <strong>{{$nextFight.Fighter2Name}}{{if and $.CurrentMVP (eq $.CurrentMVP.SettingValue (printf "%d" $nextFight.Fighter2ID))}} ðŸ‘‘{{end}}</strong></div>
					</div>
				</aside>
			{{end}}
		</section>
	{{end}}

	<div class="section-wrap">
		<div class="section-title">
			<h3>ðŸ¥Š TODAY'S SCHEDULE</h3>
			<div class="now">{{.Now.Format "Monday, January 2, 2006 at 3:04 PM MST"}}</div>
		</div>
		{{if .Fights}}
			<section class="grid">
				{{/* Daily ad in first position, if available */}}
				{{if gt (len .ShopItems) 0}}
					{{ $todayIndex := mod (int64 (add (.Now.YearDay) (.Now.Year))) (len .ShopItems) }}
					{{ $ad := index .ShopItems $todayIndex }}
					{{ $owned := false }}
					{{if .UserInventory}}
						{{range .UserInventory}}
							{{if and (eq .ShopItemID $ad.ID) (gt .Quantity 0)}}
								{{ $owned = true }}
							{{end}}
						{{end}}
					{{end}}
					<div class="fight-card ad-card" onclick="event.stopPropagation()">
						<div class="ad-left"><span class="ad-emoji">{{$ad.Emoji}}</span></div>
						<div class="ad-body">
							<div class="ad-title">{{$ad.Name}}</div>
							<div class="ad-sub">Lengthen your aura. Ingredients: pulverized robot horn, ghost pepper oil, 0.01% mystery goo.</div>
						</div>
						<div class="ad-cta">
							<button class="ad-buy {{if $owned}}disabled{{end}}" data-item-id="{{$ad.ID}}" data-item-name="{{$ad.Name}}" {{if $owned}}disabled aria-disabled="true"{{end}}>{{if $owned}}OWNED{{else}}TRY â€¢ 1M{{end}}</button>
						</div>
					</div>
				{{end}}
                {{range $i, $fight := .Fights}}
                    {{if or (eq $fight.Status "scheduled") (eq $fight.Status "active")}}
                        {{ $f1 := index $.FighterMap $fight.Fighter1ID }}
                        {{ $f2 := index $.FighterMap $fight.Fighter2ID }}
                        {{ $hasUndead := or (and $f1 $f1.IsUndead) (and $f2 $f2.IsUndead) }}
                        <div class="fight-card status-{{$fight.Status}} {{if and (eq $fight.Status "scheduled") (index $.UserBetFightIDs $fight.ID)}}bet-placed{{end}} {{if $hasUndead}}undead-present{{end}}" onclick="window.location='/fight/{{$fight.ID}}'">
							<div class="fight-time"><span class="time-display">{{$fight.ScheduledTime.Format "3:04 PM"}}</span></div>
							<div class="match">
								<div class="names">
                                    <a href="/fighter/{{$fight.Fighter1ID}}" onclick="event.stopPropagation()">{{$fight.Fighter1Name}}</a>{{if and $f1 $f1.IsUndead}} <span class="undead-dot" title="Undead"></span>{{end}}{{if and $.CurrentMVP (eq $.CurrentMVP.SettingValue (printf "%d" $fight.Fighter1ID))}} <span>ðŸ‘‘</span>{{end}} vs 
                                    <a href="/fighter/{{$fight.Fighter2ID}}" onclick="event.stopPropagation()">{{$fight.Fighter2Name}}</a>{{if and $f2 $f2.IsUndead}} <span class="undead-dot" title="Undead"></span>{{end}}{{if and $.CurrentMVP (eq $.CurrentMVP.SettingValue (printf "%d" $fight.Fighter2ID))}} <span>ðŸ‘‘</span>{{end}}
								</div>
								<div class="sub" style="color:var(--idx-dim)">Slot {{add $i 1}}</div>
							</div>
							<div class="status {{if eq $fight.Status "active"}}live{{else}}upcoming{{end}}">{{if eq $fight.Status "active"}}LIVE{{else}}UPCOMING{{end}}</div>
						</div>

					{{end}}
				{{end}}
			</section>

			<section class="grid" style="margin-top: 10px;">
                {{range $i, $fight := .Fights}}
                    {{if or (eq $fight.Status "completed") (eq $fight.Status "voided")}}
                        {{ $f1 := index $.FighterMap $fight.Fighter1ID }}
                        {{ $f2 := index $.FighterMap $fight.Fighter2ID }}
                        {{ $hasUndead := or (and $f1 $f1.IsUndead) (and $f2 $f2.IsUndead) }}
                        <div class="fight-card status-{{$fight.Status}} {{if $hasUndead}}undead-present{{end}}" onclick="window.location='/fight/{{$fight.ID}}'">
							<div class="fight-time"><span class="time-display">{{$fight.ScheduledTime.Format "3:04 PM"}}</span></div>
							<div class="match">
								<div class="names">
                                    <a href="/fighter/{{$fight.Fighter1ID}}" onclick="event.stopPropagation()">{{$fight.Fighter1Name}}</a>{{if and $f1 $f1.IsUndead}} <span class="undead-dot" title="Undead"></span>{{end}}{{if and $.CurrentMVP (eq $.CurrentMVP.SettingValue (printf "%d" $fight.Fighter1ID))}} <span>ðŸ‘‘</span>{{end}} vs 
                                    <a href="/fighter/{{$fight.Fighter2ID}}" onclick="event.stopPropagation()">{{$fight.Fighter2Name}}</a>{{if and $f2 $f2.IsUndead}} <span class="undead-dot" title="Undead"></span>{{end}}{{if and $.CurrentMVP (eq $.CurrentMVP.SettingValue (printf "%d" $fight.Fighter2ID))}} <span>ðŸ‘‘</span>{{end}}
								</div>
								<div class="sub" style="color:var(--idx-dim)">Fight {{add $i 1}}</div>
							</div>
							<div class="status {{if eq $fight.Status "voided"}}voided{{else}}completed{{end}}">{{if eq $fight.Status "voided"}}VOIDED{{else}}COMPLETED{{end}}</div>
						</div>
					{{end}}
				{{end}}
			</section>
		{{else}}
			<div class="no-fights">
				<h3>ðŸ’€ NO VIOLENCE SCHEDULED ðŸ’€</h3>
				<p>The fighters are probably touching grass or something equally disturbing.</p>
			</div>
		{{end}}
	</div>

	<script src="/static/js/index.js"></script>
	<script src="/static/js/ad.js"></script>
	<script>
		// Lightweight progress meter tied to the next fight's target time
		(function(){
			var el = document.querySelector('.countdown-timer');
			var meter = document.getElementById('idxMeterFill');
			if (!el || !meter) return;
			var target = new Date(el.getAttribute('data-target-time')).getTime();
			var total = 30 * 60 * 1000; // 30 minutes window
			function tick(){
				var now = Date.now();
				var toTarget = target - now;
				// Clamp remaining to the last 30 minutes before target
				var remaining = Math.max(0, Math.min(total, toTarget));
				var pct = ((total - remaining) / total) * 100;
				meter.style.width = pct + '%';
				if (toTarget <= 0) return; requestAnimationFrame(tick);
			}
			tick();
		})();
	</script>
{{end}}
