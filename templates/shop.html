{{define "content"}}
<div class="shop-container">
    <div class="shop-header">
        <h1>ðŸ›’ THE CHAOS MARKETPLACE</h1>
        <p class="shop-subtitle">Purchase items to manipulate the fabric of reality itself</p>
        <div class="credits-display">
            {{if .User}}
                <span class="credits-amount">ðŸ’° {{.User.Credits}} Credits</span>
            {{else}}
                <span class="credits-amount">ðŸ”’ Login Required</span>
            {{end}}
        </div>
    </div>

    {{if .User}}
    {{if .UserInventory}}
    <div class="inventory-section">
        <h2>ðŸŽ’ YOUR CHAOS INVENTORY ðŸŽ’</h2>
        <div class="inventory-grid">
            {{range .UserInventory}}
            {{ $isCombat := eq .ItemType "fighter_creation" }}
            {{ $isSponsorship := eq .ItemType "fighter_sponsorship" }}
            {{ $isLicense := or $isCombat $isSponsorship }}
            <div class="inventory-item {{if $isLicense}}clickable-license{{end}}" 
                 {{if $isCombat}}onclick="window.location.href='/user/create-fighter'"{{else if $isSponsorship}}onclick="window.location.href='/user/sponsorships'"{{end}}>
                <div class="inventory-emoji">{{.Emoji}}</div>
                <div class="inventory-name">{{.Name}}</div>
                <div class="inventory-quantity">Ã—{{.Quantity}}</div>
                {{if $isCombat}}
                    <div class="license-hint">Click to create fighter!</div>
                {{else if $isSponsorship}}
                    <div class="license-hint">Click to assign sponsorship</div>
                {{end}}
            </div>
            {{end}}
        </div>
    </div>
    {{end}}

    <div class="shop-grid">
        {{range $shopItem := .ShopItems}}
        {{/* Check if user already owns unique items (MVP, fighter_creation, fighter_sponsorship, high_roller) */}}
        {{$userOwnsItem := false}}
        {{if and (or (eq $shopItem.ItemType "mvp_player") (eq $shopItem.ItemType "fighter_creation") (eq $shopItem.ItemType "fighter_sponsorship") (eq $shopItem.ItemType "high_roller")) $.UserInventory}}
            {{range $.UserInventory}}
                {{if and (eq .ShopItemID $shopItem.ID) (gt .Quantity 0)}}
                    {{$userOwnsItem = true}}
                {{end}}
            {{end}}
        {{end}}
        {{$sponsorshipLocked := and (eq $shopItem.ItemType "fighter_sponsorship") (gt $.PendingSponsorshipCount 0)}}
        {{if and (eq $shopItem.ItemType "genetic_splicer") (not $.HasLicensedFighters)}}
            {{continue}}
        {{end}}
        
        <div class="shop-item {{if or (lt $.User.Credits $shopItem.Price) $userOwnsItem $sponsorshipLocked}}disabled{{end}}" data-item-id="{{$shopItem.ID}}" data-price="{{$shopItem.Price}}">
            <div class="item-emoji">{{$shopItem.Emoji}}</div>
            <div class="item-name">{{$shopItem.Name}}</div>
            <div class="item-description" title="{{if eq $shopItem.ItemType "high_roller"}}A portion of proceeds support the Little Spoodys Endowment for the Arts & Youth Enrichment (and other discretionary initiatives). Weekly patron tithe applies (7.5%).{{else if eq $shopItem.ItemType "fighter_sponsorship"}}Sponsor your favorite fighterâ€™s training-camp fees. Includes commemorative genome archive rights (keepsake use only).{{else}}{{$shopItem.Description}}{{end}}">
                {{if eq $shopItem.ItemType "high_roller"}}
                    Increase max bet to 100M. Patron status included. Weekly tithe: 7.5%.
                {{else if eq $shopItem.ItemType "fighter_sponsorship"}}
                    Covers training camp fees, hydration paste, and morale enrichment. Includes archival access to the fighterâ€™s genome (non-exclusive, keepsake only; no illegal gene splicing, resale, alteration, hybridizing, or fetish applications).
                {{else}}
                    {{$shopItem.Description}}
                {{end}}
            </div>
            <div class="item-price">ðŸ’° {{$shopItem.Price}} Credits</div>
            <button class="buy-button" 
                    {{if or (lt $.User.Credits $shopItem.Price) $userOwnsItem $sponsorshipLocked}}disabled{{end}}
                    onclick="purchaseItem({{$shopItem.ID}}, '{{$shopItem.Name}}', {{$shopItem.Price}})">
                {{if $sponsorshipLocked}}
                    ASSIGN IN SPONSORSHIP DESK
                {{else if $userOwnsItem}}
                    ALREADY OWNED
                {{else if lt $.User.Credits $shopItem.Price}}
                    TOO POOR
                {{else}}
                    BUY NOW
                {{end}}
            </button>
            
            {{/* Quick buy buttons - hide for unique items (MVP, fighter_creation, high_roller) */}}
            {{if and $.User (ne $shopItem.ItemType "mvp_player") (ne $shopItem.ItemType "fighter_creation") (ne $shopItem.ItemType "high_roller")}}
                <div class="quick-buy-section">
                    <div class="quick-buy-label">BULK BUY:</div>
                    <div class="quick-buy-buttons">
                        <button class="quick-buy-btn" 
                                {{if lt $.User.Credits (mul $shopItem.Price 5)}}disabled{{end}}
                                onclick="purchaseItem({{$shopItem.ID}}, '{{$shopItem.Name}}', {{$shopItem.Price}}, 5)">
                            5x
                        </button>
                        <button class="quick-buy-btn" 
                                {{if lt $.User.Credits (mul $shopItem.Price 10)}}disabled{{end}}
                                onclick="purchaseItem({{$shopItem.ID}}, '{{$shopItem.Name}}', {{$shopItem.Price}}, 10)">
                            10x
                        </button>
                        <button class="quick-buy-btn" 
                                {{if lt $.User.Credits (mul $shopItem.Price 25)}}disabled{{end}}
                                onclick="purchaseItem({{$shopItem.ID}}, '{{$shopItem.Name}}', {{$shopItem.Price}}, 25)">
                            25x
                        </button>
                    </div>
                </div>
            {{end}}
        </div>
        {{end}}
    </div>
    <div class="back-alley-note">
        {{if .HasLicensedFighters}}
            <div class="unlocked">
                <a class="mini-cta" href="/user/hybrids">Proceed to private vendor</a>
            </div>
        {{end}}
    </div>
    {{else}}
    <div class="login-required">
        <h3>ðŸ”’ AUTHENTICATION REQUIRED ðŸ”’</h3>
        <p>You must be logged in to access the chaos marketplace.</p>
        <a href="/auth" class="auth-button">LOGIN WITH DISCORD</a>
    </div>
    {{end}}
</div>

<!-- Patron Laminate (High Roller) Modal -->
<div id="highroller-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Patron Disclosure â€” Itemized Receipt</h3>
        </div>
        <div class="modal-body">
            <p class="modal-sub">Weekly Patron Tithe: 7.5% of account balance (applied Mondays)</p>
            <div class="receipt">
                <div class="row"><span class="item">Little Spoodys Endowment for the Arts</span><span class="pct">3.5%</span></div>
                <div class="row"><span class="item">Youth Enrichment & Afterâ€‘Naps</span><span class="pct">1.5%</span></div>
                <div class="row"><span class="item">Administrative Handling Fee</span><span class="pct">1.0%</span></div>
                <div class="row"><span class="item">Community Outreach â–‘â–‘â–‘â–‘â–‘â–‘</span><span class="pct">0.5%</span></div>
                <div class="row"><span class="item">Executive Wellness & Recovery</span><span class="pct">1.0%</span></div>
            </div>
            <div class="terms">Terms: Nonâ€‘refundable patronage; allocations may drift; filings may be decorative; access may be revoked for cause or vibes.</div>
        </div>
        <div class="modal-actions">
            <button id="hr-cancel" class="modal-btn secondary">Cancel</button>
            <button id="hr-confirm" class="modal-btn primary">OK</button>
        </div>
    </div>
    </div>

<script src="/static/js/shop.js"></script>

<style>
/* Modal base */
.hidden { display: none; }
.modal { position: fixed; left: 0; top: 0; right: 0; bottom: 0; z-index: 9999; }
.modal-overlay { position: absolute; left: 0; top: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(2px); }
.modal-content {
    position: relative;
    max-width: 680px;
    margin: 8vh auto;
    background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 50%, #16213e 100%);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    padding: 24px 28px;
    color: #fff;
}
.modal-header h3 {
    margin: 0 0 10px 0;
    font-size: 1.6rem;
    letter-spacing: 1px;
    text-transform: uppercase;
}
.modal-sub { color: rgba(255,255,255,0.8); margin: 0 0 16px 0; }
.receipt { border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px 14px; background: rgba(0,0,0,0.25); }
.receipt .row { display: flex; align-items: baseline; gap: 12px; padding: 6px 0; }
.receipt .row .item { position: relative; flex: 1; }
.receipt .row .item:after { content: "................................................................"; position: absolute; left: 0; right: 0; color: rgba(255,255,255,0.25); pointer-events: none; overflow: hidden; white-space: nowrap; }
.receipt .row .pct { min-width: 48px; text-align: right; font-variant-numeric: tabular-nums; }
.terms { margin-top: 14px; font-size: 0.9rem; color: rgba(255,255,255,0.75); }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 18px; }
.modal-btn { border: 0; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 700; letter-spacing: 0.5px; }
.modal-btn.primary { background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: #000; }
.modal-btn.secondary { background: #2a2a2a; color: #fff; border: 1px solid #444; }
.modal-btn.primary:hover { filter: brightness(1.05); }
.modal-btn.secondary:hover { background: #333; }
</style>
{{end}} 