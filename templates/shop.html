{{define "content"}}
<div class="shop-container">
    <div class="shop-header">
        <h1>ðŸ›’ THE CHAOS MARKETPLACE</h1>
        <p class="shop-subtitle">Purchase items to manipulate the fabric of reality itself</p>
        <div class="credits-display">
            {{if .User}}
                <span class="credits-amount">ðŸ’° {{.User.Credits}} Credits</span>
            {{else}}
                <span class="credits-amount">ðŸ”’ Login Required</span>
            {{end}}
        </div>
    </div>

    {{if .User}}
    {{if .UserInventory}}
    <div class="inventory-section">
        <h2>ðŸŽ’ YOUR CHAOS INVENTORY ðŸŽ’</h2>
        <div class="inventory-grid">
            {{range .UserInventory}}
            <div class="inventory-item {{if eq .ItemType "fighter_creation"}}clickable-license{{end}}" 
                 {{if eq .ItemType "fighter_creation"}}onclick="window.location.href='/user/create-fighter'"{{end}}>
                <div class="inventory-emoji">{{.Emoji}}</div>
                <div class="inventory-name">{{.Name}}</div>
                <div class="inventory-quantity">Ã—{{.Quantity}}</div>
                {{if eq .ItemType "fighter_creation"}}
                    <div class="license-hint">Click to create fighter!</div>
                {{end}}
            </div>
            {{end}}
        </div>
    </div>
    {{end}}

    <div class="shop-grid">
        {{range $shopItem := .ShopItems}}
        {{/* Check if user already owns unique items (MVP, fighter_creation, high_roller) */}}
        {{$userOwnsItem := false}}
        {{if and (or (eq $shopItem.ItemType "mvp_player") (eq $shopItem.ItemType "fighter_creation") (eq $shopItem.ItemType "high_roller")) $.UserInventory}}
            {{range $.UserInventory}}
                {{if and (eq .ShopItemID $shopItem.ID) (gt .Quantity 0)}}
                    {{$userOwnsItem = true}}
                {{end}}
            {{end}}
        {{end}}
        
        <div class="shop-item {{if or (lt $.User.Credits $shopItem.Price) $userOwnsItem}}disabled{{end}}" data-item-id="{{$shopItem.ID}}" data-price="{{$shopItem.Price}}">
            <div class="item-emoji">{{$shopItem.Emoji}}</div>
            <div class="item-name">{{$shopItem.Name}}</div>
            <div class="item-description" title="{{if eq $shopItem.ItemType "high_roller"}}A portion of proceeds support the Little Spoodys Endowment for the Arts & Youth Enrichment (and other discretionary initiatives). Weekly patron tithe applies.{{else}}{{$shopItem.Description}}{{end}}">
                {{if eq $shopItem.ItemType "high_roller"}}
                    Increase max bet to 100M. Patron status included.
                {{else}}
                    {{$shopItem.Description}}
                {{end}}
            </div>
            <div class="item-price">ðŸ’° {{$shopItem.Price}} Credits</div>
            <button class="buy-button" 
                    {{if or (lt $.User.Credits $shopItem.Price) $userOwnsItem}}disabled{{end}}
                    onclick="purchaseItem({{$shopItem.ID}}, '{{$shopItem.Name}}', {{$shopItem.Price}})">
                {{if $userOwnsItem}}
                    ALREADY OWNED
                {{else if lt $.User.Credits $shopItem.Price}}
                    TOO POOR
                {{else}}
                    BUY NOW
                {{end}}
            </button>
            
            {{/* Quick buy buttons - hide for unique items (MVP, fighter_creation, high_roller) */}}
            {{if and $.User (ne $shopItem.ItemType "mvp_player") (ne $shopItem.ItemType "fighter_creation") (ne $shopItem.ItemType "high_roller")}}
                <div class="quick-buy-section">
                    <div class="quick-buy-label">BULK BUY:</div>
                    <div class="quick-buy-buttons">
                        <button class="quick-buy-btn" 
                                {{if lt $.User.Credits (mul $shopItem.Price 5)}}disabled{{end}}
                                onclick="purchaseItem({{$shopItem.ID}}, '{{$shopItem.Name}}', {{$shopItem.Price}}, 5)">
                            5x
                        </button>
                        <button class="quick-buy-btn" 
                                {{if lt $.User.Credits (mul $shopItem.Price 10)}}disabled{{end}}
                                onclick="purchaseItem({{$shopItem.ID}}, '{{$shopItem.Name}}', {{$shopItem.Price}}, 10)">
                            10x
                        </button>
                        <button class="quick-buy-btn" 
                                {{if lt $.User.Credits (mul $shopItem.Price 25)}}disabled{{end}}
                                onclick="purchaseItem({{$shopItem.ID}}, '{{$shopItem.Name}}', {{$shopItem.Price}}, 25)">
                            25x
                        </button>
                    </div>
                </div>
            {{end}}
        </div>
        {{end}}
    </div>
    {{else}}
    <div class="login-required">
        <h3>ðŸ”’ AUTHENTICATION REQUIRED ðŸ”’</h3>
        <p>You must be logged in to access the chaos marketplace.</p>
        <a href="/auth" class="auth-button">LOGIN WITH DISCORD</a>
    </div>
    {{end}}
</div>

<!-- Patron Laminate (High Roller) Modal -->
<div id="highroller-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Patron Disclosure â€” Itemized Receipt</h3>
        </div>
        <div class="modal-body">
            <p class="modal-sub">Weekly Patron Tithe: 20% of account balance (applied Mondays)</p>
            <div class="receipt">
                <div class="row"><span>Little Spoodys Endowment for the Arts</span><span>11%</span></div>
                <div class="row"><span>Youth Enrichment & Afterâ€‘Naps</span><span>3%</span></div>
                <div class="row"><span>Administrative Handling Fee</span><span>3%</span></div>
                <div class="row"><span>Community Outreach â–‘â–‘â–‘â–‘â–‘â–‘</span><span>1%</span></div>
                <div class="row"><span>Executive Wellness & Recovery</span><span>2%</span></div>
            </div>
            <div class="terms">
                <p>Terms: Nonâ€‘refundable patronage; allocations may drift; filings may be decorative; access may be revoked for cause or vibes.</p>
            </div>
        </div>
        <div class="modal-actions">
            <button id="hr-cancel" class="modal-btn secondary">Cancel</button>
            <button id="hr-confirm" class="modal-btn primary">OK</button>
        </div>
    </div>
    </div>

<script src="/static/js/shop.js"></script>
{{end}} 