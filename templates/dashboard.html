{{define "content"}}
<div class="dashboard-container">
    {{if .User}}
        <div class="dashboard-header">
            <h2>üéÆ VIOLENCE COMMAND CENTER üéÆ</h2>
            <p class="dashboard-subtitle">Monitor your chaos portfolio and betting operations</p>
        </div>

        <!-- Profile Link Widget -->
        <div class="dashboard-widget profile-link-widget">
            <div class="widget-header">
                <span class="widget-icon">üîó</span>
                <h4 class="widget-title">Your Public Profile</h4>
            </div>
            <div class="profile-link-content">
                <p class="profile-link-description">Share your violence statistics and chaos achievements with the world!</p>
                <div class="profile-link-display">
                    <a href="/user/@{{if .User.CustomUsername}}{{.User.CustomUsername}}{{else}}{{.User.Username}}{{end}}" class="profile-link-url" id="profileUrl" target="_blank" title="Click to view your profile">
                        spoodblort.com/user/@{{if .User.CustomUsername}}{{.User.CustomUsername}}{{else}}{{.User.Username}}{{end}}
                    </a>
                    <button class="copy-profile-button" onclick="copyProfileLink()" title="Copy profile link">
                        <span class="copy-icon">üìÑ</span>
                        <span class="copy-text">Copy</span>
                    </button>
                </div>
                <div class="profile-link-actions">
                    <a href="/user/@{{if .User.CustomUsername}}{{.User.CustomUsername}}{{else}}{{.User.Username}}{{end}}" class="view-profile-button" target="_blank">
                        üëÅÔ∏è View Your Profile
                    </a>
                </div>
            </div>
        </div>

        <!-- Masonry Layout - Pinterest Style -->
        <div class="dashboard-masonry">
            <!-- Left Column -->
            <div class="dashboard-column">
                <!-- User Info Widget -->
                <div class="dashboard-widget user-info-card">
                    <div class="user-avatar">
                        {{if .User.AvatarURL}}
                            <img src="{{.User.AvatarURL}}" alt="Avatar" class="avatar">
                        {{else}}
                            <div class="avatar" style="background: #333; display: flex; align-items: center; justify-content: center; font-size: 2rem;">üë§</div>
                        {{end}}
                    </div>
                    <div class="user-details">
                        <h3>Welcome, {{if .User.CustomUsername}}{{.User.CustomUsername}}{{else}}{{.User.Username}}{{end}}!</h3>
                        <div class="user-meta">
                            <div class="meta-item">
                                <span class="meta-label">üí∞ Violence Credits</span>
                                <span class="meta-value credits">{{.User.Credits}}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">üìÖ Chaos Initiation</span>
                                <span class="meta-value">{{.User.CreatedAt.Format "January 2, 2006"}}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">üéØ Betting Status</span>
                                <span class="meta-value">Ready for Violence</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Widget -->
                <div class="dashboard-widget stats-widget">
                    <div class="widget-header">
                        <span class="widget-icon">üìä</span>
                        <h4 class="widget-title">Violence Statistics</h4>
                    </div>
                    <div class="stats-list">
                        {{if .BettingStats}}
                        <div class="stat-row">
                            <div class="stat-info">
                                <span class="stat-emoji">‚è≥</span>
                                <span class="stat-text">Active Bets</span>
                            </div>
                            <div class="stat-number">{{.BettingStats.ActiveBets}}</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-info">
                                <span class="stat-emoji">üéØ</span>
                                <span class="stat-text">Total Bets</span>
                            </div>
                            <div class="stat-number">{{.BettingStats.TotalBets}}</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-info">
                                <span class="stat-emoji">üèÜ</span>
                                <span class="stat-text">Win Rate</span>
                            </div>
                            <div class="stat-number">{{printf "%.1f%%" .BettingStats.WinRate}}</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-info">
                                <span class="stat-emoji">‚öñÔ∏è</span>
                                <span class="stat-text">Win/Loss Ratio</span>
                            </div>
                            <div class="stat-number">
                                {{if eq .BettingStats.BetsLost 0}}
                                    {{if gt .BettingStats.BetsWon 0}}Perfect{{else}}‚Äî{{end}}
                                {{else}}
                                    {{printf "%.2f" .BettingStats.WinLossRatio}}
                                {{end}}
                            </div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-info">
                                <span class="stat-emoji">üí∞</span>
                                <span class="stat-text">Net Profit</span>
                            </div>
                            <div class="stat-number {{if lt .BettingStats.NetProfit 0}}negative{{else if gt .BettingStats.NetProfit 0}}positive{{end}}">
                                {{if ge .BettingStats.NetProfit 0}}+{{end}}{{.BettingStats.NetProfit}}
                            </div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-info">
                                <span class="stat-emoji">üìà</span>
                                <span class="stat-text">Avg Bet Size</span>
                            </div>
                            <div class="stat-number">{{printf "%.0f" .BettingStats.AvgBetSize}}</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-info">
                                <span class="stat-emoji">üöÄ</span>
                                <span class="stat-text">Biggest Win</span>
                            </div>
                            <div class="stat-number positive">{{.BettingStats.BiggestWin}}</div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-info">
                                <span class="stat-emoji">üíÄ</span>
                                <span class="stat-text">Existential Dread</span>
                            </div>
                            <div class="stat-number">Maximum</div>
                        </div>
                        {{else}}
                        <div class="stat-row">
                            <div class="stat-info">
                                <span class="stat-emoji">üìä</span>
                                <span class="stat-text">No betting data yet</span>
                            </div>
                            <div class="stat-number">‚Äî</div>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="dashboard-column">
                <!-- Inventory Widget -->
                {{if .UserInventory}}
                <div class="dashboard-widget inventory-section">
                    <h3>üéí YOUR CHAOS INVENTORY</h3>
                    <div class="inventory-grid">
                        {{range .UserInventory}}
                        {{ $isCombat := eq .ItemType "fighter_creation" }}
                        {{ $isSponsorship := eq .ItemType "fighter_sponsorship" }}
                        {{ $isLicense := or $isCombat $isSponsorship }}
                        <div class="inventory-item {{if $isLicense}}clickable-license{{end}} {{if eq .ItemType "serum"}}{{if $.SerumUsedToday}}serum-disabled{{else}}clickable-serum{{end}}{{end}}" 
                             {{if $isCombat}}onclick="window.location.href='/user/create-fighter'"{{else if $isSponsorship}}onclick="window.location.href='/user/sponsorships'"{{end}}
                             {{if and (eq .ItemType "serum") (not $.SerumUsedToday)}}data-shop-item-id="{{.ShopItemID}}" onclick="openSerumModal({{.ShopItemID}}, '{{.Name}}')"{{end}}>
                            <div class="inventory-emoji">{{.Emoji}}</div>
                            <div class="inventory-name">{{.Name}}</div>
                            <div class="inventory-quantity">√ó{{.Quantity}}</div>
                            {{if and (eq .ItemType "serum") $.SerumUsedToday}}
                                <div class="serum-disabled-hint">Daily limit reached</div>
                            {{end}}
                            {{if $isCombat}}
                                <div class="license-hint">Click to create fighter!</div>
                            {{else if $isSponsorship}}
                                <div class="license-hint">Assign sponsorship</div>
                            {{end}}
                        </div>
                        {{end}}
                    </div>
                </div>
                {{else}}
                <div class="dashboard-widget inventory-section">
                    <h3>üéí YOUR CHAOS INVENTORY</h3>
                    <div class="inventory-empty">
                        <div class="empty-state">
                            <span style="font-size: 3rem; opacity: 0.5;">üì¶</span>
                            <p>No items yet</p>
                            <a href="/shop" class="action-button secondary">Visit Shop</a>
                        </div>
                    </div>
                </div>
                {{end}}

                <!-- Betting History Widget -->
                <div class="dashboard-widget betting-history-widget">
                    <div class="widget-header">
                        <span class="widget-icon">üìà</span>
                        <h4 class="widget-title">Betting History</h4>
                    </div>
                    {{if .UserBets}}
                        <div class="betting-history">
                            {{range $index, $bet := .UserBets}}
                                {{if lt $index 50}}
                                    <a href="/fight/{{$bet.FightID}}" class="bet-history-link">
                                        <div class="bet-history-item status-{{$bet.Status}}">
                                            <div class="bet-fight-info">
                                                <div class="bet-fighters">{{$bet.Fighter1Name}} vs {{$bet.Fighter2Name}}</div>
                                                <div class="bet-details">
                                                    {{$bet.Amount}} credits on {{$bet.FighterName}}
                                                    <span class="bet-status status-{{$bet.Status}}">
                                                        {{if eq $bet.Status "pending"}}‚è≥ Pending
                                                        {{else if eq $bet.Status "won"}}‚úÖ Won
                                                        {{else if eq $bet.Status "lost"}}‚ùå Lost
                                                        {{else if eq $bet.Status "voided"}}‚ö™ Voided
                                                        {{end}}
                                                    </span>
                                                </div>
                                            </div>
                                            {{if eq $bet.Status "won"}}
                                                {{if $bet.Payout.Valid}}
                                                    <div class="bet-payout">+{{$bet.Payout.Int64}} credits</div>
                                                {{end}}
                                            {{end}}
                                        </div>
                                    </a>
                                {{end}}
                            {{end}}
                            {{if gt (len .UserBets) 50}}
                                <div class="bet-history-more">
                                    <small>And {{sub (len .UserBets) 50}} more bets...</small>
                                </div>
                            {{end}}
                        </div>
                    {{else}}
                        <div class="activity-placeholder">
                            üèúÔ∏è No betting activity yet<br>
                            <small>Time to embrace the chaos!</small>
                        </div>
                    {{end}}
                </div>
            </div>
        </div>

    {{else}}
        <div class="dashboard-header">
            <h2>üö´ ACCESS VIOLATION</h2>
            <p class="dashboard-subtitle">Identity verification required</p>
        </div>
        <div class="dashboard-widget user-info-card">
            <div class="user-details" style="text-align: center; width: 100%;">
                <h3>Authentication Required</h3>
                <p>You must be logged in to access the Violence Command Center.</p>
                <a href="/auth" class="action-button primary" style="margin-top: 20px; display: inline-block;">üîê Login via Discord</a>
            </div>
        </div>
    {{end}}
</div>

<!-- Serum (Drugs) Modal -->
<div id="serumModal" class="modal hidden">
    <div class="modal-overlay" onclick="closeSerumModal()"></div>
    <div class="modal-card">
        <div class="modal-header">
            <h4 id="serumModalTitle">Select a Deceased Fighter</h4>
            <button class="modal-close" onclick="closeSerumModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="serumEligibleList" class="eligible-list">Loading...</div>
        </div>
        <div class="modal-footer">
            <button class="action-button secondary" onclick="closeSerumModal()">Cancel</button>
        </div>
    </div>
  </div>

<script>
function openSerumModal(shopItemId, name){
  try { if (window.toast && window.toast.info) window.toast.info('Loading morgue...', 1200); } catch(_){}
  const modal = document.getElementById('serumModal');
  const title = document.getElementById('serumModalTitle');
  const list = document.getElementById('serumEligibleList');
  title.textContent = name + ' ‚Äî Apply to deceased';
  list.innerHTML = 'Loading...';
  fetch('/user/drugs/eligible').then(r=>r.json()).then(d=>{
    if (!d || !d.success){ list.innerHTML = 'Failed to load.'; return; }
    if (!d.fighters || d.fighters.length === 0){ list.innerHTML = '<div class="empty">No eligible corpses. Check back later.</div>'; return; }
    list.innerHTML = '<div class="serum-policy">Policy: You may apply <strong>one</strong> serum per day to a <em>single</em> deceased fighter. The serum dose is fully consumed on use.</div>';
    d.fighters.forEach(function(f){
      var row = document.createElement('div');
      row.className = 'eligible-row';
      var fname = (f && (f.Name || f.name)) || 'Unknown';
      var fid = (f && (typeof f.ID !== 'undefined' ? f.ID : f.id));
      row.innerHTML = '<div class="f-name">' + fname + '</div>' +
                      '<button class="action-button" data-fid="'+fid+'">Reanimate</button>';
      row.querySelector('button').addEventListener('click', function(){
        applySerum(shopItemId, fid, name);
      });
      list.appendChild(row);
    });
  }).catch(function(){ list.innerHTML = 'Network error.'; });
  modal.classList.remove('hidden');
}
function closeSerumModal(){ document.getElementById('serumModal').classList.add('hidden'); }
function applySerum(shopItemId, fighterId, itemName){
  // Mini animation pre-result
  const list = document.getElementById('serumEligibleList');
  const anim = document.createElement('div');
  anim.className = 'serum-anim';
  anim.innerHTML = '<div class="vial"></div><div class="anim-text">Infusing...</div>';
  list.prepend(anim);
  fetch('/user/drugs/apply', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ shop_item_id: shopItemId, fighter_id: fighterId }) })
    .then(r=>r.json())
    .then(function(d){
      if (d && d.success){
        if (d.worked){ anim.classList.add('success'); try { if (window.toast && window.toast.success) window.toast.success('Reanimation successful. Subject is now UNDEAD.', 5000); } catch(_){ } }
        else { anim.classList.add('failure'); try { if (window.toast && window.toast.warning) window.toast.warning('Serum failed to bind. Subject remains deceased.', 5000); } catch(_){ } }
        closeSerumModal();
        // Live update: decrement/remove serum card and lock rest for today
        try {
          const grid = document.querySelector('.inventory-grid');
          if (grid){
            const card = grid.querySelector('.inventory-item[data-shop-item-id="'+shopItemId+'"][class*="serum"]');
            if (card){
              const qtyEl = card.querySelector('.inventory-quantity');
              let qty = 1;
              if (qtyEl){
                const m = (qtyEl.textContent||'').match(/\d+/); qty = m ? parseInt(m[0],10) : 1;
              }
              if (qty <= 1){ card.remove(); }
              else { if (qtyEl) qtyEl.textContent = '√ó' + (qty-1); }
            }
            // Disable any other serum cards for the day
            grid.querySelectorAll('.inventory-item.clickable-serum').forEach(function(el){
              el.classList.remove('clickable-serum');
              el.classList.add('serum-disabled');
              el.removeAttribute('onclick');
              let hint = el.querySelector('.serum-disabled-hint');
              if (!hint){ hint = document.createElement('div'); hint.className='serum-disabled-hint'; hint.textContent='Daily limit reached'; el.appendChild(hint); }
            });
          }
        } catch(_){ }
      } else {
        var msg = (d && d.error) ? d.error : 'Failed to apply';
        try { if (window.toast && window.toast.error) window.toast.error(msg, 4500); } catch(_){ }
      }
    })
    .catch(function(){ try { if (window.toast && window.toast.error) window.toast.error('Network error', 4000); } catch(_){ } });
}
</script>

<script>
function copyProfileLink() {
    const profileUrl = document.getElementById('profileUrl').textContent;
    const fullUrl = window.location.protocol + '//' + profileUrl;
    
    // Try to use the modern clipboard API first
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(fullUrl).then(function() {
            showCopySuccess();
        }).catch(function() {
            fallbackCopyTextToClipboard(fullUrl);
        });
    } else {
        // Fallback for older browsers or non-HTTPS
        fallbackCopyTextToClipboard(fullUrl);
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showCopySuccess();
    } catch (err) {
        console.error('Failed to copy: ', err);
        showError('Failed to copy link. Please copy manually: ' + text);
    }
    
    document.body.removeChild(textArea);
}

function showCopySuccess() {
    const button = document.querySelector('.copy-profile-button');
    const originalText = button.innerHTML;
    
    button.innerHTML = '<span class="copy-icon">‚úÖ</span><span class="copy-text">Copied!</span>';
    button.style.background = '#4caf50';
    
    setTimeout(function() {
        button.innerHTML = originalText;
        button.style.background = '';
    }, 2000);
}
</script>
{{end}} 