{{define "content"}}
<div class="fight-container">
    {{if .Fight}}
        <!-- Fight Navigation Arrows -->
        <div class="fight-nav-left">
            <a href="/fight/{{sub .Fight.ID 1}}" class="nav-arrow" title="Previous Fight">‚Äπ</a>
        </div>
        <div class="fight-nav-right">
            <a href="/fight/{{add .Fight.ID 1}}" class="nav-arrow" title="Next Fight">‚Ä∫</a>
        </div>

        <div class="fight-header">
            <h2 class="fight-title">ü•ä VIOLENCE BREAKDOWN</h2>
            
            <!-- Commissioner's Blessing Stamp -->
            <div class="commissioner-stamp stamp-position-{{mod .Fight.ID 6}}" title="THE COMMISSIONER has officially blessed this violence matchup on {{.Fight.ScheduledTime.Format "January 2, 2006"}}. All participants have been deemed sufficiently chaotic for public consumption. Department of Recreational Violence - Violence Division.">
                <div class="stamp-text">BLESSED</div>
                <div class="stamp-subtext">{{.Fight.ScheduledTime.Format "01-02-06"}}</div>
                <div class="stamp-subtext">APPROVED</div>
            </div>
            
            <div class="fight-meta">
                <div class="meta-badge">
                    <span class="meta-label">üìÖ Scheduled Violence</span>
                    <span class="meta-value">{{.Fight.ScheduledTime.Format "Monday, January 2, 2006 at 3:04 PM"}}</span>
                </div>
                <div class="meta-badge">
                    <span class="meta-label">‚ö° Combat Status</span>
                    <span class="meta-value status-{{.Fight.Status}}">
                        {{if eq .Fight.Status "active"}}üî¥ LIVE VIOLENCE
                        {{else if eq .Fight.Status "completed"}}‚úÖ VIOLENCE COMPLETE
                        {{else if eq .Fight.Status "voided"}}‚ùå VOIDED BY CHAOS
                        {{else}}‚è±Ô∏è VIOLENCE PENDING{{end}}
                    </span>
                </div>
            </div>
        </div>

		<div class="fighter-matchup">
			{{/* Tale of the Tape (shown before betting and before the cards) */}}
			{{if and .Fighter1 .Fighter2}}
			<div class="fight-section-card">
			<div class="tale-of-tape">
				<div class="tot-col left">
					<div class="tot-fighter-avatar">
						<img src="{{.Fighter1.AvatarURL}}" alt="{{.Fight.Fighter1Name}}" class="tot-avatar-img">
					</div>
					<div class="tot-fighter-name">{{.Fight.Fighter1Name}}</div>
					<div class="tot-row"><span class="label">Strength</span><span id="tot-f1-strength" class="value {{if gt .Fighter1.Strength .Fighter2.Strength}}win{{end}}">{{.Fighter1.Strength}}</span></div>
					<div class="tot-row"><span class="label">Speed</span><span id="tot-f1-speed" class="value {{if gt .Fighter1.Speed .Fighter2.Speed}}win{{end}}">{{.Fighter1.Speed}}</span></div>
					<div class="tot-row"><span class="label">Endurance</span><span id="tot-f1-endurance" class="value {{if gt .Fighter1.Endurance .Fighter2.Endurance}}win{{end}}">{{.Fighter1.Endurance}}</span></div>
					<div class="tot-row"><span class="label">Technique</span><span id="tot-f1-technique" class="value {{if gt .Fighter1.Technique .Fighter2.Technique}}win{{end}}">{{.Fighter1.Technique}}</span></div>
					<div class="tot-row subtle"><span class="label">Molecular Density</span><span class="value {{if gt .Fighter1.MolecularDensity .Fighter2.MolecularDensity}}win{{end}}">{{printf "%.1f" .Fighter1.MolecularDensity}}</span></div>
					<div class="tot-row subtle"><span class="label">Existential Dread</span><span class="value {{if gt .Fighter1.ExistentialDread .Fighter2.ExistentialDread}}win{{end}}">{{.Fighter1.ExistentialDread}}</span></div>
					<div class="tot-row subtle"><span class="label">Fingers</span><span class="value {{if gt .Fighter1.Fingers .Fighter2.Fingers}}win{{end}}">{{.Fighter1.Fingers}}</span></div>
					<div class="tot-row subtle"><span class="label">Toes</span><span class="value {{if gt .Fighter1.Toes .Fighter2.Toes}}win{{end}}">{{.Fighter1.Toes}}</span></div>
				</div>
				<div class="tot-center">
					<div class="tot-title">TALE OF THE TAPE</div>
					<div class="tot-faceoff">{{.Fight.Fighter1Name}} <span class="vs-dot">VS</span> {{.Fight.Fighter2Name}}</div>
				</div>
				<div class="tot-col right">
					<div class="tot-fighter-avatar">
						<img src="{{.Fighter2.AvatarURL}}" alt="{{.Fight.Fighter2Name}}" class="tot-avatar-img">
					</div>
					<div class="tot-fighter-name">{{.Fight.Fighter2Name}}</div>
					<div class="tot-row"><span id="tot-f2-strength" class="value {{if gt .Fighter2.Strength .Fighter1.Strength}}win{{end}}">{{.Fighter2.Strength}}</span><span class="label">Strength</span></div>
					<div class="tot-row"><span id="tot-f2-speed" class="value {{if gt .Fighter2.Speed .Fighter1.Speed}}win{{end}}">{{.Fighter2.Speed}}</span><span class="label">Speed</span></div>
					<div class="tot-row"><span id="tot-f2-endurance" class="value {{if gt .Fighter2.Endurance .Fighter1.Endurance}}win{{end}}">{{.Fighter2.Endurance}}</span><span class="label">Endurance</span></div>
					<div class="tot-row"><span id="tot-f2-technique" class="value {{if gt .Fighter2.Technique .Fighter1.Technique}}win{{end}}">{{.Fighter2.Technique}}</span><span class="label">Technique</span></div>
					<div class="tot-row subtle"><span class="value {{if gt .Fighter2.MolecularDensity .Fighter1.MolecularDensity}}win{{end}}">{{printf "%.1f" .Fighter2.MolecularDensity}}</span><span class="label">Molecular Density</span></div>
					<div class="tot-row subtle"><span class="value {{if gt .Fighter2.ExistentialDread .Fighter1.ExistentialDread}}win{{end}}">{{.Fighter2.ExistentialDread}}</span><span class="label">Existential Dread</span></div>
					<div class="tot-row subtle"><span class="value {{if gt .Fighter2.Fingers .Fighter1.Fingers}}win{{end}}">{{.Fighter2.Fingers}}</span><span class="label">Fingers</span></div>
					<div class="tot-row subtle"><span class="value {{if gt .Fighter2.Toes .Fighter1.Toes}}win{{end}}">{{.Fighter2.Toes}}</span><span class="label">Toes</span></div>
				</div>
			</div>
			</div>
			{{end}}
			<div class="fight-section-card">
			<div class="matchup-grid">
                <div class="fighter-card">
                    <h4 class="fighter-name">
                        <a href="/fighter/{{.Fight.Fighter1ID}}">{{.Fight.Fighter1Name}}</a>
                        {{if eq .Fight.Status "completed"}}
                            {{if .Fight.WinnerID.Valid}}
                                {{if eq .Fight.WinnerID.Int64 .Fight.Fighter1ID}}
                                    <span class="outcome-badge winner-badge">WINNER</span>
                                {{else}}
                                    <span class="outcome-badge loser-badge">LOSER</span>
                                {{end}}
                            {{end}}
                        {{end}}
                        {{if or .Fighter1Effects (gt .Fighter1Curses 0) (gt .Fighter1Blessings 0)}}
                            <div class="effect-indicators">
                                {{if gt .Fighter1Curses 0}}
                                    <div class="effect-badge curse-badge" title="Fighter Curse applied {{.Fighter1Curses}} time(s) - Fighter health reduced by {{mul .Fighter1Curses 10000}}">
                                        <span class="effect-emoji">üíÄ</span>
                                        <span class="effect-count">{{.Fighter1Curses}}x</span>
                                    </div>
                                {{end}}
                                {{if gt .Fighter1Blessings 0}}
                                    <div class="effect-badge blessing-badge" title="Fighter Blessing applied {{.Fighter1Blessings}} time(s) - Fighter health increased by {{mul .Fighter1Blessings 10000}}">
                                        <span class="effect-emoji">‚ú®</span>
                                        <span class="effect-count">{{.Fighter1Blessings}}x</span>
                                    </div>
                                {{end}}
                            </div>
                        {{end}}
                    </h4>
                    {{if .Fight.FinalScore1.Valid}}
                        <div class="fighter-score">{{.Fight.FinalScore1.Int64}}</div>
                        <small>Final Damage Dealt</small>
                    {{else}}
                        <div style="color: #888; font-style: italic;">Awaiting Violence</div>
                    {{end}}
                    {{if and .User (eq .Fight.Status "scheduled")}}
                        {{if not .UserBet}}
                            <div class="fighter-betting">
                                <form action="/user/fight/{{.Fight.ID}}/bet" method="POST" class="bet-form" onsubmit="return confirmBet(event, '{{.Fight.Fighter1Name}}')">
                                    <input type="hidden" name="fighter_id" value="{{.Fight.Fighter1ID}}">
                                    <div class="bet-controls">
                                        <input type="number" name="amount" min="1" max="{{if gt .FightBetMax 0}}{{min .FightBetMax .User.Credits}}{{else}}{{.User.Credits}}{{end}}" placeholder="Credits" class="bet-input" required title="Max bet: {{if gt .FightBetMax 0}}{{min .FightBetMax .User.Credits}}{{else}}{{.User.Credits}}{{end}}">
                                        <button type="button" class="bet-max-button" title="Set to max">MAX</button>
                                        <button type="submit" class="bet-button">BET</button>
                                    </div>
                                    {{if and .CurrentMVP (eq .CurrentMVP.SettingValue (printf "%d" .Fight.Fighter1ID))}}
                                    <div class="mvp-hint">üëë Betting on your MVP pays 10x if they win</div>
                                    {{end}}
                                </form>
                            </div>
                        {{else if eq .UserBet.FighterID .Fight.Fighter1ID}}
                            <div class="fighter-bet-placed">
                                <div class="bet-amount">{{commas .UserBet.Amount}} credits</div>
                                <div class="bet-label">YOUR BET</div>
                            </div>
                        {{end}}
                    {{end}}

                </div>
                
                <div class="vs-section">
                    <div class="vs-chip">VS</div>
                    <div class="status-display">
                        {{if eq .Fight.Status "scheduled"}}<span class="pill next">UPCOMING</span>
                        {{else if eq .Fight.Status "active"}}<span class="pill live">LIVE</span>
                        {{else if eq .Fight.Status "completed"}}<span class="pill completed">COMPLETED</span>
                        {{else}}<span class="pill voided">VOIDED</span>{{end}}
                    </div>
                </div>
                
                <div class="fighter-card">
                    <h4 class="fighter-name">
                        <a href="/fighter/{{.Fight.Fighter2ID}}">{{.Fight.Fighter2Name}}</a>
                        {{if or .Fighter2Effects (gt .Fighter2Curses 0) (gt .Fighter2Blessings 0)}}
                            <div class="effect-indicators">
                                {{if gt .Fighter2Curses 0}}
                                    <div class="effect-badge curse-badge" title="Fighter Curse applied {{.Fighter2Curses}} time(s) - Fighter health reduced by {{mul .Fighter2Curses 10000}}">
                                        <span class="effect-emoji">üíÄ</span>
                                        <span class="effect-count">{{.Fighter2Curses}}x</span>
                                    </div>
                                {{end}}
                                {{if gt .Fighter2Blessings 0}}
                                    <div class="effect-badge blessing-badge" title="Fighter Blessing applied {{.Fighter2Blessings}} time(s) - Fighter health increased by {{mul .Fighter2Blessings 10000}}">
                                        <span class="effect-emoji">‚ú®</span>
                                        <span class="effect-count">{{.Fighter2Blessings}}x</span>
                                    </div>
                                {{end}}
                            </div>
                        {{end}}
                    </h4>
                    {{if .Fight.FinalScore2.Valid}}
                        <div class="fighter-score">{{.Fight.FinalScore2.Int64}}</div>
                        <small>Final Damage Dealt</small>
                    {{else}}
						<div style="color: #888; font-style: italic;">Awaiting Violence</div>
                    {{end}}
                    {{if and .User (eq .Fight.Status "scheduled")}}
                        {{if not .UserBet}}
                            <div class="fighter-betting">
                                <form action="/user/fight/{{.Fight.ID}}/bet" method="POST" class="bet-form" onsubmit="return confirmBet(event, '{{.Fight.Fighter2Name}}')">
                                    <input type="hidden" name="fighter_id" value="{{.Fight.Fighter2ID}}">
                                    <div class="bet-controls">
                                        <input type="number" name="amount" min="1" max="{{if gt .FightBetMax 0}}{{min .FightBetMax .User.Credits}}{{else}}{{.User.Credits}}{{end}}" placeholder="Credits" class="bet-input" required title="Max bet: {{if gt .FightBetMax 0}}{{min .FightBetMax .User.Credits}}{{else}}{{.User.Credits}}{{end}}">
                                        <button type="button" class="bet-max-button" title="Set to max">MAX</button>
                                        <button type="submit" class="bet-button">BET</button>
                                    </div>
                                    {{if and .CurrentMVP (eq .CurrentMVP.SettingValue (printf "%d" .Fight.Fighter2ID))}}
                                    <div class="mvp-hint">üëë Betting on your MVP pays 10x if they win</div>
                                    {{end}}
                                </form>
                            </div>
                        {{else if eq .UserBet.FighterID .Fight.Fighter2ID}}
                            <div class="fighter-bet-placed">
                                <div class="bet-amount">{{commas .UserBet.Amount}} credits</div>
                                <div class="bet-label">YOUR BET</div>
                            </div>
                        {{end}}
                    {{end}}

                </div>
		</div>
		</div>


			{{/* Available credits info */}}
			{{if and .User (eq .Fight.Status "scheduled") (not .UserBet)}}
				<div class="betting-info-bar">
					Available credits: {{commas .User.Credits}} | 1:1 odds (bet 100, win 200 total)
					{{if and .CurrentMVP (or (eq .CurrentMVP.SettingValue (printf "%d" .Fight.Fighter1ID)) (eq .CurrentMVP.SettingValue (printf "%d" .Fight.Fighter2ID)))}}
						<span class="mvp-hint-inline">| üëë MVP bonus: 10x payout if your MVP wins</span>
					{{end}}
				</div>
			{{end}}
		</div>

        {{/* Bless/Curse Section */}}
        {{if and .User (eq .Fight.Status "scheduled") .UserInventory}}
            <div class="effects-section">
                <h4>üîÆ MANIPULATE THE CHAOS üîÆ</h4>
                <div class="effects-grid">
                    {{range .UserInventory}}
                        {{if or (eq .ItemType "fighter_curse") (eq .ItemType "fighter_blessing")}}
                            <div class="effect-item">
                                <div class="effect-header">
                                    <span class="effect-emoji">{{.Emoji}}</span>
                                    <span class="effect-name">{{.Name}}</span>
                                    <span class="effect-quantity">√ó{{.Quantity}}</span>
                                </div>
                                <div class="effect-description">{{.Description}}</div>
                                <div class="effect-targets">
                                    <button class="effect-button" 
                                        data-item-id="{{.ShopItemID}}"
                                        data-fight-id="{{$.Fight.ID}}"
                                        data-fighter-id="{{$.Fight.Fighter1ID}}"
                                        data-fighter-name="{{$.Fight.Fighter1Name}}"
                                        data-effect-name="{{.Name}}"
                                        onclick="applyEffectFromButton(this)">
                                        Apply to {{$.Fight.Fighter1Name}}
                                    </button>
                                    <button class="effect-button"
                                        data-item-id="{{.ShopItemID}}"
                                        data-fight-id="{{$.Fight.ID}}"
                                        data-fighter-id="{{$.Fight.Fighter2ID}}"
                                        data-fighter-name="{{$.Fight.Fighter2Name}}"
                                        data-effect-name="{{.Name}}"
                                        onclick="applyEffectFromButton(this)">
                                        Apply to {{$.Fight.Fighter2Name}}
                                    </button>
                                </div>
                            </div>
                        {{end}}
                    {{end}}
                </div>
            </div>
        {{end}}

        {{if .Fight.WinnerID.Valid}}
            <div class="result-section">
                <h4>üèÜ VIOLENCE VICTOR</h4>
                <div class="winner-name">
                    {{if eq .Fight.WinnerID.Int64 .Fight.Fighter1ID}}
                        {{.Fight.Fighter1Name}}
                    {{else if eq .Fight.WinnerID.Int64 .Fight.Fighter2ID}}
                        {{.Fight.Fighter2Name}}
                    {{end}}
                </div>
                {{if .Fight.CompletedAt.Valid}}
                    <div class="completion-time">
                        Violence concluded.
                    </div>
                {{end}}
            </div>
        {{else if eq .Fight.Status "completed"}}
            <div class="result-section draw-result">
                <h4>ü§ù MUTUAL DESTRUCTION</h4>
                <div class="winner-name">Fight ended in chaos equilibrium</div>
                <div style="color: #888; font-style: italic;">No one wins when everyone loses</div>
            </div>
        {{end}}

        {{if .Fight.VoidedReason.Valid}}
            <div class="voided-section">
                <h4>üíÄ VOID TRANSMISSION</h4>
                <div class="void-reason">{{.Fight.VoidedReason.String}}</div>
            </div>
        {{end}}

        {{if .User}}
            {{if .AllBets}}
            <div class="betting-section">
                <h3>üí∞ ACTION SUMMARY</h3>
                {{if .UserBet}}
                    <div class="user-bet-status">
                        <strong>Your Bet:</strong> {{commas .UserBet.Amount}} credits on 
                        {{if eq .UserBet.FighterID .Fight.Fighter1ID}}{{.Fight.Fighter1Name}}{{else}}{{.Fight.Fighter2Name}}{{end}}
                        {{if eq .UserBet.Status "resolved"}}
                            {{if .UserBet.Payout.Valid}}
                                - <span class="win-status">WON {{commas .UserBet.Payout.Int64}} credits! üéâ</span>
                            {{else}}
                                - <span class="loss-status">LOST üí∏</span>
                            {{end}}
                        {{end}}
                    </div>
                {{end}}
                
                <div class="betting-summary">
                    <div class="bet-count">{{len .AllBets}} degenerates have placed bets</div>
                    {{$fighter1Bets := 0}}
                    {{$fighter2Bets := 0}}
                    {{$totalAmount := 0}}
                    {{range .AllBets}}
                        {{$totalAmount = add $totalAmount .Amount}}
                        {{if eq .FighterID $.Fight.Fighter1ID}}
                            {{$fighter1Bets = add $fighter1Bets 1}}
                        {{else}}
                            {{$fighter2Bets = add $fighter2Bets 1}}
                        {{end}}
                    {{end}}
                    <div class="bet-stats-quick">
                        <span><strong>{{.Fight.Fighter1Name}}:</strong> {{$fighter1Bets}} bets</span> | 
                        <span><strong>{{.Fight.Fighter2Name}}:</strong> {{$fighter2Bets}} bets</span> | 
                        <span><strong>Total Wagered:</strong> {{commas $totalAmount}} credits</span>
                    </div>
                </div>

                <div class="detailed-bets">
                    <h4>üé≠ BETS, BLESSINGS, AND CURSES</h4>
                    <div class="bets-list">
                        {{range .AllBets}}
                        <div class="bet-notification {{if eq .UserID $.User.ID}}user-bet{{end}}">
                            <div class="bet-main-line">
                                <span class="bettor-name">{{getDisplayName .Username .CustomUsername}}</span>
                                <span class="bet-info">
                                    {{commas .Amount}} credits ‚Üí {{.FighterName}}
                                    {{if eq .Status "resolved"}}
                                        {{if .Payout.Valid}}
                                            <span class="win-badge">+{{commas .Payout.Int64}}</span>
                                        {{else}}
                                            <span class="loss-badge">LOST</span>
                                        {{end}}
                                    {{end}}
                                </span>
                            </div>
                            <!-- Show effects applied by this user as separate notification lines -->
                            {{$userID := .UserID}}
                            {{range $.UserEffectsOnFight}}
                                {{if eq .UserID $userID}}
                                <div class="effect-notification {{if or (eq .EffectType "strength_blessing") (eq .EffectType "speed_blessing") (eq .EffectType "endurance_blessing") (eq .EffectType "technique_blessing")}}blessing-notif{{else}}curse-notif{{end}}">
                                    {{if eq .EffectType "strength_blessing"}}
                                        ‚ú® Applied strength blessing to {{.TargetName}}
                                    {{else if eq .EffectType "speed_blessing"}}
                                        ‚ú® Applied speed blessing to {{.TargetName}}
                                    {{else if eq .EffectType "endurance_blessing"}}
                                        ‚ú® Applied endurance blessing to {{.TargetName}}
                                    {{else if eq .EffectType "technique_blessing"}}
                                        ‚ú® Applied technique blessing to {{.TargetName}}
                                    {{else if eq .EffectType "strength_curse"}}
                                        üíÄ Applied strength curse to {{.TargetName}}
                                    {{else if eq .EffectType "speed_curse"}}
                                        üíÄ Applied speed curse to {{.TargetName}}
                                    {{else if eq .EffectType "endurance_curse"}}
                                        üíÄ Applied endurance curse to {{.TargetName}}
                                    {{else if eq .EffectType "technique_curse"}}
                                        üíÄ Applied technique curse to {{.TargetName}}
                                    {{else}}
                                        ‚ö° Applied {{.EffectType}} to {{.TargetName}}
                                    {{end}}
                                </div>
                                {{end}}
                            {{end}}
                        </div>
                        {{end}}
                    </div>
                </div>

			</div>
			{{end}}
        {{else}}
            <div class="auth-prompt">
                <h4>üîê AUTHENTICATION REQUIRED</h4>
                <p><a href="/auth">Authenticate via Discord to access violence wagering systems</a></p>
            </div>
        {{end}}

        <div style="text-align: center; margin-top: 30px;">
            <a href="/" class="back-button">‚Üê Return to Violence Schedule</a>
        </div>
    {{else}}
        <div class="error-section">
            <h2>üíÄ VIOLENCE NOT FOUND</h2>
            <p>The requested violence event has been absorbed into the chaos void.</p>
            <div style="margin-top: 20px;">
                <a href="/" class="back-button">‚Üê Return to Schedule</a>
            </div>
        </div>
    {{end}}
</div>

<script src="/static/js/fight-navigation.js"></script>
<script src="/static/js/betting.js"></script>
<script src="/static/js/fight.js"></script>
{{end}} 