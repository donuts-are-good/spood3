<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Necro-Lattice Demo 4</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg: #0a0717;
            --bg-grad-1: rgba(117, 59, 255, 0.25);
            --bg-grad-2: rgba(255, 148, 45, 0.28);
            --panel: rgba(19, 16, 33, 0.85);
            --panel-ghost: rgba(26, 22, 46, 0.68);
            --border: rgba(255, 255, 255, 0.15);
            --border-strong: rgba(255, 255, 255, 0.28);
            --text: #f8f4ff;
            --muted: rgba(248, 244, 255, 0.72);
            --accent: #ff8f1f;
            --accent-strong: #ff6b35;
            --success: #45f0c5;
            --danger: #ff4f6d;
            --warning: #ffd447;
            --shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background:
                radial-gradient(circle at 15% 25%, var(--bg-grad-1), transparent 50%),
                radial-gradient(circle at 85% 15%, var(--bg-grad-2), transparent 52%),
                linear-gradient(155deg, #020108 0%, #0f0a24 45%, #030108 100%);
            color: var(--text);
            overflow: hidden;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 14px;
            border-radius: 10px;
            background: rgba(8, 6, 16, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.18);
            color: var(--text);
            font-size: 0.9rem;
            opacity: 0;
            transform: translateY(-4px);
            transition: 180ms ease;
            pointer-events: none;
            z-index: 999;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Replace bulky top bar with a compact mast row */
        .mast {
            display: grid;
            grid-template-columns: minmax(220px, 1fr) 2fr auto;
            gap: 12px;
            align-items: center;
            padding: 8px 12px 0 12px;
        }
        .mast-title {
            font-weight: 800; letter-spacing: 3px; font-size: 1.1rem;
        }
        .mast-metrics { display: flex; gap: 10px; }
        .mini-metric { background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 8px 10px; display: grid; gap: 2px; }
        .mini-metric span { font-size: 0.7rem; color: var(--muted); letter-spacing: .5px; }
        .mini-metric b { font-size: 0.95rem; }

        .game-info {
            flex: 1;
            display: grid;
            gap: 8px;
        }

        .eyebrow {
            margin: 0;
            font-size: 0.7rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--muted);
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .tagline {
            margin: 0;
            font-size: 0.85rem;
            line-height: 1.4;
            color: var(--muted);
        }

        .metrics {
            flex: 0 1 320px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .metric {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 14px;
            display: grid;
            gap: 4px;
        }

        .metric span:first-child {
            font-size: 0.7rem;
            color: var(--muted);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .metric span:last-child {
            font-size: 1.1rem;
            font-weight: 700;
        }

        main {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(12, minmax(0, 1fr));
            grid-auto-rows: minmax(0, 1fr);
            gap: 12px;
            padding: 12px;
            overflow: hidden;
        }

        .panel {
            background: var(--panel);
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            position: relative;
            overflow: hidden;
            min-height: 0;
        }

        .panel header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .panel h2 {
            margin: 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1.4px;
        }

        .panel p {
            margin: 0;
            color: var(--muted);
            font-size: 0.8rem;
            line-height: 1.4;
        }

        /* 2x2 page grid: left = betting (7 cols), right = display/controls (5 cols) */
        .sectors-panel {
            grid-column: 1 / span 7;
            grid-row: 1;
            min-height: 0;
        }

        .glyph-lines-panel {
            grid-column: 1 / span 7;
            grid-row: 2;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .glyph-panel {
            grid-column: 8 / span 5;
            grid-row: 1;
            min-height: 0;
        }

        .control-panel {
            grid-column: 8 / span 5;
            grid-row: 2;
            display: grid;
            gap: 12px;
            grid-template-rows: auto; /* only planner remains */
            min-height: 0;
            overflow: hidden;
        }

        @media (max-width: 1200px) {
            .sectors-panel,
            .glyph-lines-panel,
            .glyph-panel,
            .control-panel {
                grid-column: 1 / span 12;
                grid-row: auto;
            }
            .control-panel { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
            .line-list { grid-template-columns: 1fr; } /* collapse to single column on smaller screens */
        }

        @media (max-width: 900px) {
            main {
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }
            .sectors-panel, .glyph-panel, .control-panel {
                grid-column: span 6;
            }
        }

        .chip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .chip {
            display: grid;
            gap: 4px;
            padding: 12px 10px 10px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: 130ms ease;
            text-align: left;
        }

        .chip span:first-child {
            font-size: 0.68rem;
            color: rgba(255, 255, 255, 0.85);
            letter-spacing: 0.8px;
            text-transform: uppercase;
        }

        .chip span:last-child {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
        }

        .chip:hover {
            background: rgba(255, 143, 31, 0.14);
            border-color: rgba(255, 143, 31, 0.55);
        }

        .chip.active {
            border-color: rgba(255, 143, 31, 0.9);
            background: radial-gradient(circle, rgba(255, 143, 31, 0.28) 0%, rgba(255, 143, 31, 0.1) 70%);
            box-shadow: 0 8px 26px rgba(255, 143, 31, 0.25);
        }

        .glyph-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 90px));
            gap: 12px;
            justify-content: center;
            padding: 16px;
            border-radius: 18px;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glyph-panel { min-height: 0; }
        .glyph-panel .glyph-grid { flex: 0 0 auto; }

        .glyph {
            width: 90px;
            height: 90px;
            border-radius: 16px;
            border: 2px solid rgba(255, 255, 255, 0.18);
            background: rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            color: rgba(255, 255, 255, 0.8);
            transition: 130ms ease;
            font-weight: bold;
        }

        .glyph.lit {
            border-color: var(--warning);
            background: radial-gradient(circle, rgba(255, 212, 71, 0.35) 0%, rgba(255, 212, 71, 0.12) 70%);
            color: var(--warning);
            box-shadow: 0 0 28px rgba(255, 212, 71, 0.3);
            text-shadow: 0 0 12px rgba(255, 212, 71, 0.6);
        }

        .glyph.obelisk {
            font-size: 1.8rem;
        }

        .glyph.obelisk.lit {
            border-color: var(--accent-strong);
            color: var(--accent-strong);
            box-shadow: 0 0 32px rgba(255, 100, 54, 0.4);
            text-shadow: 0 0 16px rgba(255, 100, 54, 0.7);
        }

        .line-list {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr)); /* 4x2 on desktop */
            gap: 8px;
            overflow-y: auto;
            max-height: none;
            align-content: start;
        }

        .line-chip {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px dashed rgba(255, 255, 255, 0.18);
            background: rgba(255, 255, 255, 0.04);
            cursor: pointer;
            transition: 130ms ease;
        }

        .line-chip span:first-child {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .line-chip span:last-child {
            font-size: 0.75rem;
            color: var(--muted);
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .line-chip:hover {
            border-color: rgba(255, 143, 31, 0.5);
            background: rgba(255, 143, 31, 0.12);
        }

        .line-chip.active {
            border-style: solid;
            border-color: rgba(255, 143, 31, 0.85);
            background: rgba(255, 143, 31, 0.2);
            box-shadow: 0 6px 22px rgba(255, 143, 31, 0.22);
        }

        .control-stack {
            display: grid;
            gap: 14px;
            background: var(--panel-ghost);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 18px;
        }

        .input-group {
            display: grid;
            gap: 6px;
        }

        .input-group label {
            font-size: 0.75rem;
            color: var(--muted);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .stake-input {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            font-size: 1rem;
        }

        .stake-input:focus {
            outline: none;
            border-color: rgba(255, 143, 31, 0.65);
            box-shadow: 0 0 0 3px rgba(255, 143, 31, 0.28);
        }

        .quick-row {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 8px;
        }

        .quick-row button {
            padding: 8px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            transition: 120ms ease;
        }

        .quick-row button:hover {
            background: rgba(255, 143, 31, 0.16);
            border-color: rgba(255, 143, 31, 0.5);
        }

        .summary-bar {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .summary-bar div {
            display: grid;
            gap: 3px;
        }

        .summary-bar span:first-child {
            font-size: 0.68rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .summary-bar span:last-child {
            font-size: 1rem;
            font-weight: 600;
        }

        .cta-button {
            padding: 14px 20px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(115deg, var(--accent) 0%, var(--accent-strong) 100%);
            color: #1f0804;
            font-size: 1.1rem;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 14px 36px rgba(255, 143, 31, 0.3);
            transition: transform 120ms ease;
        }

        .cta-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            box-shadow: none;
        }

        .cta-button:not(:disabled):hover {
            transform: translateY(-1px);
        }

        .extortion-banner {
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(255, 79, 109, 0.16);
            border: 1px solid rgba(255, 79, 109, 0.4);
            color: var(--muted);
            font-size: 0.8rem;
        }

        .extortion-banner strong {
            color: var(--danger);
        }

        /* outcome styles removed */

        .history-card {
            background: var(--panel-ghost);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            padding: 18px;
            display: grid;
            gap: 12px;
        }

        .history-card h2 {
            margin: 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1.4px;
        }

        .history-list {
            max-height: 180px;
            overflow-y: auto;
            display: grid;
            gap: 8px;
        }

        .history-item {
            font-size: 0.8rem;
            color: var(--muted);
            line-height: 1.4;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .history-item strong {
            color: var(--text);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 999px;
        }

        /* Guidance visuals */
        /* Legend (shapes instead of 1/2/3 numbers) */
        .legend { display: flex; gap: 8px; align-items: center; padding: 8px 12px 0 12px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); color: var(--muted); font-size: 0.85rem; }
        .legend-item.active { color: var(--text); border-color: rgba(255,255,255,0.18); box-shadow: 0 6px 16px rgba(255,255,255,0.1); }
        .shape { width: 16px; height: 16px; display: inline-block; }
        .shape-circle { border-radius: 50%; background: linear-gradient(120deg, #ff8f1f, #ff6b35); }
        .shape-triangle { width: 0; height: 0; border-left: 9px solid transparent; border-right: 9px solid transparent; border-bottom: 16px solid #8a5cf6; }
        .shape-square { background: #2ec0ff; border-radius: 3px; }
        .shape-hex { background: #45f0c5; clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); }
        .panel header { gap: 10px; }
        .panel header h2 { margin-left: 2px; }
    </style>
</head>
<body>
    <div class="toast" id="toast"></div>
    <!-- Mast row: title + stepper + compact metrics -->
    <div class="mast">
        <div class="mast-title">NECRO‑LATTICE</div>
        <div class="legend">
            <div class="legend-item" id="legend-select"><span class="shape shape-circle"></span><span>Select bets</span></div>
            <div class="legend-item" id="legend-stake"><span class="shape shape-square"></span><span>Set stake</span></div>
            <div class="legend-item" id="legend-spin"><span class="shape shape-triangle"></span><span>Spin</span></div>
        </div>
        <div class="mast-metrics">
            <div class="mini-metric"><span>Risked</span><b id="summaryRisk">0 VC</b></div>
            <div class="mini-metric"><span>Sectors</span><b id="summarySectors">0</b></div>
            <div class="mini-metric"><span>Glyph lines</span><b id="summaryLines">0</b></div>
            <div class="mini-metric"><span>Balance</span><b id="summaryBalance">5,000 VC</b></div>
        </div>
    </div>

    <main>
        <section class="panel sectors-panel">
            <header>
                <h2>Sectors · roulette bones</h2>
                <span class="hero-note">Tap to arm · Direct hit 10× · Adjacent 3×</span>
            </header>
            <div class="chip-grid" id="sectorGrid"></div>
        </section>

        <section class="panel glyph-panel">
            <header>
                <h2>Glyph outcome display</h2>
                <span class="hero-note">Three sigils light up every spin</span>
            </header>
            <div class="glyph-grid" id="glyphGrid"></div>
        </section>

        <section class="panel glyph-lines-panel">
            <header>
                <h2>Glyph prophecies · betting lines</h2>
                <span class="hero-note">Rows/columns 5× · Diagonals 8× (2/3 pays 3×)</span>
            </header>
            <div class="line-list" id="lineGrid"></div>
        </section>

        <section class="control-panel">
            <div class="control-stack">
                <header>
                    <h2>Wager planner</h2>
                    <span class="hero-note">Set stake · confirm risk · hammer spin</span>
                </header>
                <div class="input-group">
                    <label for="stakeInput">Base stake per selection</label>
                    <input type="number" id="stakeInput" class="stake-input" min="10" step="10" value="100">
                </div>
                <div class="quick-row">
                    <button type="button" data-stake="50">50</button>
                    <button type="button" data-stake="100">100</button>
                    <button type="button" data-stake="250">250</button>
                    <button type="button" data-stake="500">500</button>
                    <button type="button" id="maxStake">MAX</button>
                </div>
                <div class="summary-bar">
                    <div>
                        <span>Total selections</span>
                        <span id="summarySelections">0</span>
                    </div>
                    <div>
                        <span>Total risk</span>
                        <span id="summaryTotal">0 VC</span>
                    </div>
                </div>
                <button class="cta-button" id="spinBtn">Spin ritual wheel</button>
                <div class="extortion-banner" id="extortionBanner" hidden>
                    <strong>Extortion active:</strong> 10% skim on next win. Keep spinning to shake the goons.
                </div>
            </div>

            

            
        </section>
    </main>

    <script>
        const toastEl = document.getElementById('toast');
        const stakeInput = document.getElementById('stakeInput');
        const spinBtn = document.getElementById('spinBtn');
        const summaryRisk = document.getElementById('summaryRisk');
        const summarySectors = document.getElementById('summarySectors');
        const summaryLines = document.getElementById('summaryLines');
        const summaryBalance = document.getElementById('summaryBalance');
        const summarySelections = document.getElementById('summarySelections');
        const summaryTotal = document.getElementById('summaryTotal');
        const outcomeCard = document.getElementById('outcomeCard');
        const outcomeNet = document.getElementById('outcomeNet');
        const outcomeCopy = document.getElementById('outcomeCopy');
        const outcomeTags = document.getElementById('outcomeTags');
        // history removed; toasts convey win/loss
        const extortionBanner = document.getElementById('extortionBanner');

        const balanceState = {
            balance: 5000,
            consecutiveBusts: 0
        };

        // --- Payout tuning for ~2% house edge ---
        // Sector math: P(hit) = 1/13, P(adj) = 2/13.
        // Choose 9x (hit) and 1.85x (adjacent): (9 + 2*1.85)/13 ≈ 0.977 → ~2.3% house.
        const SECTOR_HIT_MULT = 9;
        const SECTOR_ADJ_MULT = 1.85;

        // Glyph line math with 3 draws from 9 (without replacement):
        // P(3-of-3) = 1/84, P(2-of-3) = 18/84.
        // Choose 28x for 3-of-3 and 3x for 2-of-3: (28 + 18*3)/84 = 82/84 ≈ 0.976 → ~2.4% house.
        const LINE_MATCH3_MULT = 28;
        const LINE_MATCH2_MULT = 3;

        // Obelisk bonus (center lit) adds EV; set to 0 to disable, or 0.25 for small extra.
        const BONUS_OBELISK_STAKE_FACTOR = 0; // keep 0 for stable house edge

        const SECTORS = [
            { id: 0, name: 'Acid Fog' },
            { id: 1, name: 'Bone Hail' },
            { id: 2, name: 'Witch Tide' },
            { id: 3, name: 'Gospel Static' },
            { id: 4, name: 'Spinal Bloom' },
            { id: 5, name: 'Ritual Ash' },
            { id: 6, name: 'Blunt Singularity' },
            { id: 7, name: 'Plasma Dirge' },
            { id: 8, name: 'Mire Choir' },
            { id: 9, name: 'Vanta Gale' },
            { id: 10, name: 'Copium Surge' },
            { id: 11, name: 'Axe Eclipse' },
            { id: 12, name: 'Cathedral Feedback' }
        ];

        const GLYPH_INDICES = Array.from({ length: 9 }, (_, i) => i);
        const LINES = [
            { id: 'row0', label: 'Row · North Veil', cells: [0, 1, 2], multiplier: 5 },
            { id: 'row1', label: 'Row · Mid Vein', cells: [3, 4, 5], multiplier: 5 },
            { id: 'row2', label: 'Row · Grave Floor', cells: [6, 7, 8], multiplier: 5 },
            { id: 'col0', label: 'Column · Spine', cells: [0, 3, 6], multiplier: 5 },
            { id: 'col1', label: 'Column · Larynx', cells: [1, 4, 7], multiplier: 5 },
            { id: 'col2', label: 'Column · Maw', cells: [2, 5, 8], multiplier: 5 },
            { id: 'diag0', label: 'Sigil Diagonal ↘', cells: [0, 4, 8], multiplier: 8 },
            { id: 'diag1', label: 'Sigil Diagonal ↙', cells: [2, 4, 6], multiplier: 8 }
        ];

        const selectedSectors = new Set();
        const selectedLines = new Set();

        function showToast(message, duration = 2400) {
            toastEl.textContent = message;
            toastEl.classList.add('show');
            clearTimeout(showToast._timer);
            showToast._timer = setTimeout(() => toastEl.classList.remove('show'), duration);
        }

        function formatCredits(n) {
            return n.toLocaleString() + ' VC';
        }

        function updateBalanceDisplay() {
            summaryBalance.textContent = formatCredits(balanceState.balance);
        }

        function updateSummary() {
            const stake = Number(stakeInput.value) || 0;
            const selections = selectedSectors.size + selectedLines.size;
            const totalRisk = selections * stake;
            summarySectors.textContent = selectedSectors.size;
            summaryLines.textContent = selectedLines.size;
            summarySelections.textContent = selections;
            summaryTotal.textContent = formatCredits(totalRisk);
            summaryRisk.textContent = formatCredits(totalRisk);
            spinBtn.disabled = selections === 0 || stake <= 0;

            // Stepper highlighting
            document.getElementById('legend-select').classList.toggle('active', selections > 0);
            document.getElementById('legend-stake').classList.toggle('active', stake > 0);
            document.getElementById('legend-spin').classList.toggle('active', selections > 0 && stake > 0);
        }

        function buildSectorGrid() {
            const grid = document.getElementById('sectorGrid');
            SECTORS.forEach(({ id, name }) => {
                const chip = document.createElement('button');
                chip.type = 'button';
                chip.className = 'chip';
                chip.dataset.id = id;
                chip.innerHTML = `<span>${id.toString().padStart(2, '0')}</span><span>${name}</span>`;
                chip.addEventListener('click', () => {
                    if (selectedSectors.has(id)) {
                        selectedSectors.delete(id);
                        chip.classList.remove('active');
                    } else {
                        selectedSectors.add(id);
                        chip.classList.add('active');
                    }
                    updateSummary();
                });
                grid.appendChild(chip);
            });
        }

        function buildGlyphGrid() {
            const grid = document.getElementById('glyphGrid');
            GLYPH_INDICES.forEach(idx => {
                const glyph = document.createElement('div');
                glyph.className = 'glyph' + (idx === 4 ? ' obelisk' : '');
                glyph.id = `glyph-${idx}`;
                glyph.textContent = idx === 4 ? '☗' : '✶';
                grid.appendChild(glyph);
            });
        }

        function buildLines() {
            const list = document.getElementById('lineGrid');
            LINES.forEach(line => {
                const item = document.createElement('div');
                item.className = 'line-chip';
                item.dataset.id = line.id;
                item.innerHTML = `<span>${line.label}</span><span>${line.multiplier}× payout</span>`;
                item.addEventListener('click', () => {
                    if (selectedLines.has(line.id)) {
                        selectedLines.delete(line.id);
                        item.classList.remove('active');
                    } else {
                        selectedLines.add(line.id);
                        item.classList.add('active');
                    }
                    updateSummary();
                });
                list.appendChild(item);
            });
        }

        function randomInt(max) {
            return Math.floor(Math.random() * max);
        }

        function drawGlyphs(count = 3) {
            const pool = [...GLYPH_INDICES];
            const drawn = [];
            while (drawn.length < count && pool.length) {
                const idx = randomInt(pool.length);
                drawn.push(pool.splice(idx, 1)[0]);
            }
            return drawn;
        }

        function highlightGlyphs(indices) {
            GLYPH_INDICES.forEach(idx => {
                document.getElementById(`glyph-${idx}`).classList.toggle('lit', indices.includes(idx));
            });
        }

        function sectorNeighbors(id) {
            const len = SECTORS.length;
            return [(id + len - 1) % len, (id + 1) % len];
        }

        function evaluateSpin({ sectorResult, glyphs, stake, bonusSpin = false }) {
            let totalPayout = 0;
            const wins = [];

            selectedSectors.forEach(sel => {
                if (sel === sectorResult) {
                    const payout = stake * SECTOR_HIT_MULT;
                    totalPayout += payout;
                    wins.push(`Sector ${sel.toString().padStart(2, '0')} direct hit · +${formatCredits(payout)}`);
                } else if (sectorNeighbors(sectorResult).includes(sel)) {
                    const payout = stake * SECTOR_ADJ_MULT;
                    totalPayout += payout;
                    wins.push(`Sector ${sel.toString().padStart(2, '0')} adjacency · +${formatCredits(payout)}`);
                }
            });

            selectedLines.forEach(lineId => {
                const line = LINES.find(l => l.id === lineId);
                if (!line) return;
                // count matches for this line
                let matches = 0;
                for (let i = 0; i < 3; i++) {
                    if (glyphs.includes(line.cells[i])) matches++;
                }
                if (matches === 3) {
                    const payout = stake * LINE_MATCH3_MULT;
                    totalPayout += payout;
                    wins.push(`${line.label} 3/3 · +${formatCredits(payout)}`);
                } else if (matches === 2) {
                    const payout = stake * LINE_MATCH2_MULT;
                    totalPayout += payout;
                    wins.push(`${line.label} 2/3 · +${formatCredits(payout)}`);
                }
            });

            const totalCost = stake * (selectedSectors.size + selectedLines.size);
            const net = totalPayout - totalCost;
            const descriptor = bonusSpin ? 'Obelisk bonus resolved' : 'Ritual spin resolved';
            renderOutcome({
                descriptor,
                sector: `${sectorResult.toString().padStart(2, '0')} · ${SECTORS[sectorResult].name}`,
                glyphs: glyphs.map(idx => idx === 4 ? 'Obelisk' : `Sigil ${idx + 1}`).join(', '),
                net,
                wins
            });
            pushHistory({ descriptor, sectorResult, glyphs, net });
            return net;
        }

        function renderOutcome({ descriptor, sector, glyphs, net, wins }) {
            outcomeCard.classList.remove('win', 'loss');
            if (net > 0) outcomeCard.classList.add('win');
            if (net < 0) outcomeCard.classList.add('loss');

            outcomeCard.querySelector('h3').textContent = descriptor;
            outcomeNet.textContent = net === 0 ? '0 VC' : `${net > 0 ? '+' : ''}${formatCredits(Math.abs(net))}`;

            if (net > 0) {
                outcomeCopy.textContent = 'Violence Credits deployed. Keep pressing while the lattice hums.';
            } else if (net < 0) {
                outcomeCopy.textContent = 'Commissioner pockets the burn. Stack more prophecy before next pull.';
            } else {
                outcomeCopy.textContent = 'Perfect balance. The ritual neither rewards nor punishes.';
            }

            outcomeTags.innerHTML = '';
            const sTag = document.createElement('span');
            sTag.className = 'tag';
            sTag.textContent = `Sector: ${sector}`;
            outcomeTags.appendChild(sTag);
            const gTag = document.createElement('span');
            gTag.className = 'tag';
            gTag.textContent = `Glyphs: ${glyphs}`;
            outcomeTags.appendChild(gTag);
            wins.forEach(text => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.textContent = text;
                outcomeTags.appendChild(tag);
            });
        }

        function pushHistory({ descriptor, sectorResult, glyphs, net }) {
            const entry = document.createElement('div');
            entry.className = 'history-item';
            entry.innerHTML = `
                <strong>${net > 0 ? 'Win' : net < 0 ? 'Loss' : 'Draw'}</strong> · ${descriptor}<br>
                Sector ${sectorResult.toString().padStart(2, '0')} · Glyphs ${glyphs.join('-')} · Net ${net > 0 ? '+' : ''}${formatCredits(net)}
            `;
            historyEl.prepend(entry);
            if (historyEl.children.length > 8) historyEl.removeChild(historyEl.lastElementChild);
        }

        function performSpin({ stake, bonusOnly = false }) {
            const sectorResult = randomInt(SECTORS.length);
            const glyphs = drawGlyphs(3);
            highlightGlyphs(glyphs);
            return { sectorResult, glyphs, stake, bonusSpin: bonusOnly };
        }

        function triggerExtortion() {
            showToast('Extortion crew found you. Next win loses 10%.', 3000);
            triggerExtortion.tax = 0.10;
            extortionBanner.hidden = false;
            setTimeout(() => {
                triggerExtortion.tax = 0;
                extortionBanner.hidden = true;
                showToast('Extortion ended. Winnings now untaxed.');
            }, 85000);
        }

        function applyExtortion(net) {
            const tax = triggerExtortion.tax || 0;
            if (!tax || net <= 0) return net;
            const skimmed = Math.floor(net * (1 - tax));
            showToast(`Goons skimmed ${formatCredits(net - skimmed)}.`);
            triggerExtortion.tax = 0;
            extortionBanner.hidden = true;
            return skimmed;
        }

        function handleSpin() {
            const stake = Math.max(Number(stakeInput.value) || 0, 0);
            const selections = selectedSectors.size + selectedLines.size;
            if (selections === 0 || stake <= 0) {
                showToast('Queue at least one sector or glyph line and set a stake.');
                return;
            }
            const totalCost = stake * selections;
            if (totalCost > balanceState.balance) {
                showToast('Insufficient Violence Credits. Dial the stake or deselect bets.');
                return;
            }

            balanceState.balance -= totalCost;
            updateBalanceDisplay();

            const primary = performSpin({ stake });
            let net = evaluateSpin(primary);

            const obeliskHit = primary.glyphs.includes(4) && selectedLines.size > 0;
            if (obeliskHit && BONUS_OBELISK_STAKE_FACTOR > 0) {
                showToast('Obelisk flare. Glyph-only bonus incoming.');
                const bonusStake = Math.max(Math.floor(stake * BONUS_OBELISK_STAKE_FACTOR), 1);
                const saved = new Set(selectedSectors);
                selectedSectors.clear();
                const bonus = performSpin({ stake: bonusStake, bonusOnly: true });
                net += evaluateSpin(bonus);
                selectedSectors.clear();
                saved.forEach(id => selectedSectors.add(id));
            }

            const finalNet = net > 0 ? applyExtortion(net) : net;
            balanceState.balance += finalNet;
            updateBalanceDisplay();

            balanceState.consecutiveBusts = finalNet <= 0 ? balanceState.consecutiveBusts + 1 : 0;
            if (balanceState.consecutiveBusts >= 2 && !triggerExtortion.tax) {
                triggerExtortion();
                balanceState.consecutiveBusts = 0;
            }

            updateSummary();
        }

        function init() {
            buildSectorGrid();
            buildGlyphGrid();
            buildLines();
            updateSummary();
            updateBalanceDisplay();

            document.querySelectorAll('.quick-row button').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.id === 'maxStake') {
                        const selections = Math.max(1, selectedSectors.size + selectedLines.size);
                        stakeInput.value = Math.max(10, Math.floor(balanceState.balance / selections));
                    } else {
                        stakeInput.value = btn.dataset.stake;
                    }
                    updateSummary();
                });
            });

            stakeInput.addEventListener('input', updateSummary);
            spinBtn.addEventListener('click', handleSpin);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
